# SD卡存储方案配置指南

本文档专门针对**仅使用64GB SD卡，无外接硬盘**的用户。

## 📋 方案概述

### 存储空间分配（64GB SD卡）

```
总容量：64GB
├── 系统分区：~10GB
│   ├── Raspberry Pi OS：~5GB
│   ├── 应用和依赖：~2GB
│   └── 系统缓存和日志：~3GB
│
└── 数据存储：~50GB（可用）
    ├── 用户文件：~40GB（推荐）
    ├── 分享文件：~5GB
    ├── 临时文件：~2GB
    └── 备份文件：~3GB
```

### 用户配额建议

| 用户类型 | 推荐配额 | 说明 |
|---------|---------|------|
| 个人使用 | 20-30GB | 适合个人文档、照片、小视频 |
| 家庭使用 | 10-15GB/人 | 3-4人共享，每人10-15GB |
| 测试环境 | 5GB | 仅用于功能测试 |

## 🔧 配置步骤

### 步骤1：修改环境变量配置

```bash
cd /opt/raspberrycloud/backend
sudo nano .env
```

修改存储路径（如果使用默认配置，已经是SD卡路径）：

```bash
# SD卡存储路径（默认配置）
STORAGE_PATH=/opt/raspberrycloud/storage/users
SHARE_PATH=/opt/raspberrycloud/storage/shares
TEMP_PATH=/opt/raspberrycloud/storage/temp
BACKUP_PATH=/opt/raspberrycloud/storage/backups

# 用户配额（SD卡方案推荐20GB）
DEFAULT_USER_QUOTA=21474836480  # 20GB
```

### 步骤2：创建存储目录

```bash
# 创建存储目录结构
sudo mkdir -p /opt/raspberrycloud/storage/{users,shares,temp,backups}

# 设置权限
sudo chown -R www-data:www-data /opt/raspberrycloud/storage
sudo chmod -R 755 /opt/raspberrycloud/storage
```

### 步骤3：检查SD卡空间

```bash
# 查看SD卡使用情况
df -h /

# 查看存储目录大小
du -sh /opt/raspberrycloud/storage/*

# 查看剩余空间
df -h /opt/raspberrycloud/storage
```

### 步骤4：配置Samba（局域网共享）

编辑Samba配置：

```bash
sudo nano /etc/samba/smb.conf
```

在文件末尾添加（注意路径改为SD卡路径）：

```ini
[cloud]
   comment = RaspberryCloud Storage (SD Card)
   path = /opt/raspberrycloud/storage/users
   browseable = yes
   writable = yes
   valid users = @cloud-users
   create mask = 0664
   directory mask = 0775
   force user = www-data
   force group = www-data
```

重启Samba：

```bash
sudo systemctl restart smbd
```

## 📊 存储空间管理

### 监控存储使用

创建监控脚本：

```bash
sudo nano /opt/raspberrycloud/scripts/check_storage.sh
```

```bash
#!/bin/bash
# SD卡存储空间检查脚本

STORAGE_DIR="/opt/raspberrycloud/storage"
THRESHOLD=85  # 使用率超过85%告警

echo "=== SD卡存储空间检查 ==="
echo "时间: $(date)"
echo ""

# 检查根分区使用率
ROOT_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
echo "根分区使用率: ${ROOT_USAGE}%"

if [ "$ROOT_USAGE" -gt "$THRESHOLD" ]; then
    echo "⚠️  警告：根分区使用率超过${THRESHOLD}%！"
fi

echo ""
echo "=== 存储目录使用情况 ==="
du -sh "$STORAGE_DIR"/* 2>/dev/null | sort -h

echo ""
echo "=== 各用户存储使用 ==="
for user_dir in "$STORAGE_DIR/users"/*; do
    if [ -d "$user_dir" ]; then
        user_id=$(basename "$user_dir")
        size=$(du -sh "$user_dir" | cut -f1)
        echo "用户 $user_id: $size"
    fi
done

echo ""
echo "=== 临时文件 ==="
TEMP_SIZE=$(du -sh "$STORAGE_DIR/temp" 2>/dev/null | cut -f1)
echo "临时文件: $TEMP_SIZE"

echo ""
echo "=== 备份文件 ==="
BACKUP_SIZE=$(du -sh "$STORAGE_DIR/backups" 2>/dev/null | cut -f1)
echo "备份文件: $BACKUP_SIZE"
```

```bash
chmod +x /opt/raspberrycloud/scripts/check_storage.sh

# 测试运行
/opt/raspberrycloud/scripts/check_storage.sh
```

### 设置定时清理

```bash
sudo crontab -e
```

添加以下任务：

```bash
# 每天凌晨2点清理临时文件（超过1天）
0 2 * * * find /opt/raspberrycloud/storage/temp -type f -mtime +1 -delete

# 每天凌晨3点检查存储空间
0 3 * * * /opt/raspberrycloud/scripts/check_storage.sh >> /var/log/raspberrycloud/storage_check.log 2>&1

# 每周日凌晨1点清理旧备份（保留最近7天）
0 1 * * 0 find /opt/raspberrycloud/storage/backups -type f -mtime +7 -delete
```

## ⚠️ 重要注意事项

### 1. SD卡寿命管理

SD卡有写入次数限制，建议：

```bash
# 减少不必要的日志写入
sudo nano /opt/raspberrycloud/backend/.env
# 设置 DEBUG=false

# 使用tmpfs减少SD卡写入（可选）
sudo nano /etc/fstab
# 添加：
tmpfs /tmp tmpfs defaults,noatime,nosuid,size=100M 0 0
tmpfs /var/tmp tmpfs defaults,noatime,nosuid,size=50M 0 0
```

### 2. 定期备份

SD卡可能损坏，必须定期备份：

```bash
# 修改备份脚本使用SD卡路径
sudo nano /opt/raspberrycloud/scripts/backup.sh
```

修改为：

```bash
BACKUP_DIR="/opt/raspberrycloud/storage/backups"
DB_PATH="/opt/raspberrycloud/backend/raspberrycloud.db"
DATA_DIR="/opt/raspberrycloud/storage/users"
```

**重要**：定期将备份文件复制到其他设备（电脑、网盘等）！

### 3. 空间不足处理

当存储空间不足时：

```bash
# 1. 清理临时文件
sudo rm -rf /opt/raspberrycloud/storage/temp/*

# 2. 清理旧备份
sudo rm -f /opt/raspberrycloud/storage/backups/*_$(date -d '7 days ago' +%Y%m%d)*.gz

# 3. 清理系统日志
sudo journalctl --vacuum-time=7d

# 4. 清理APT缓存
sudo apt clean

# 5. 检查大文件
sudo find /opt/raspberrycloud/storage -type f -size +100M -exec ls -lh {} \;
```

### 4. 性能优化

SD卡读写速度较慢，建议：

```bash
# 1. 使用Class 10或UHS-I SD卡
# 2. 减少同时上传文件数
# 3. 启用Nginx缓存
# 4. 定期清理碎片（ext4文件系统自动处理）
```

## 🔄 从外接硬盘迁移到SD卡

如果之前使用外接硬盘，现在要迁移到SD卡：

```bash
# 1. 停止服务
sudo systemctl stop raspberrycloud

# 2. 创建SD卡存储目录
sudo mkdir -p /opt/raspberrycloud/storage/{users,shares,temp,backups}

# 3. 复制数据（如果数据量不大）
sudo cp -r /mnt/cloud_storage/users/* /opt/raspberrycloud/storage/users/
sudo cp -r /mnt/cloud_storage/shares/* /opt/raspberrycloud/storage/shares/

# 4. 修改配置文件
sudo nano /opt/raspberrycloud/backend/.env
# 修改存储路径为SD卡路径

# 5. 设置权限
sudo chown -R www-data:www-data /opt/raspberrycloud/storage

# 6. 重启服务
sudo systemctl start raspberrycloud
```

## 📈 存储扩展方案

如果64GB不够用，可以考虑：

### 方案1：升级SD卡

- 升级到128GB或256GB SD卡
- 使用SD卡克隆工具迁移系统
- 扩展分区大小

### 方案2：添加外接存储（未来）

- 购买USB 3.0移动硬盘
- 按照[硬件准备文档](01-硬件准备与初始化.md)配置
- 修改存储路径到外接硬盘

### 方案3：网络存储

- 挂载网络驱动器（NFS/SMB）
- 使用云存储同步（如Nextcloud）

## ✅ 配置检查清单

- [ ] 已修改.env配置文件（SD卡路径）
- [ ] 已创建存储目录并设置权限
- [ ] 已检查SD卡剩余空间（>10GB）
- [ ] 已配置用户配额（建议20GB/用户）
- [ ] 已设置定时清理任务
- [ ] 已配置备份脚本
- [ ] 已测试存储读写功能
- [ ] 已设置存储空间监控

## 🎉 完成

SD卡存储方案配置完成！现在系统将使用SD卡存储数据。

**重要提醒**：
- ⚠️ SD卡有写入寿命限制，建议定期备份
- ⚠️ 存储空间有限，注意管理文件大小
- ⚠️ 重要数据请备份到其他设备

接下来继续按照[系统部署教程](02-系统部署教程.md)完成部署。

