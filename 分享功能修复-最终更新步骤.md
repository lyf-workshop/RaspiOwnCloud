# åˆ†äº«åŠŸèƒ½ä¿®å¤ - æœ€ç»ˆæ›´æ–°æ­¥éª¤

## âœ… ä½ çš„ç³»ç»Ÿæ¶æ„

- **å‰ç«¯æœåŠ¡**: Nginx â†’ `/var/www/raspberrycloud/`
- **åç«¯æœåŠ¡**: FastAPI â†’ `/opt/raspberrycloud/backend/`
- **éƒ¨ç½²æ–¹å¼**: åŒæ–‡ä»¶å¤¹ï¼ˆæ›´æ–°æ–‡ä»¶å¤¹ + ç”Ÿäº§æ–‡ä»¶å¤¹ï¼‰

## ğŸ“¦ å·²ä¿®æ”¹çš„æ–‡ä»¶

### åœ¨ä½ çš„æ›´æ–°æ–‡ä»¶å¤¹ (F:\Github\RaspiOwnCloud)

1. âœ… **frontend/share.html** - åˆ†äº«é¡µé¢ï¼ˆæ–°å¢ï¼‰
2. âœ… **frontend/js/share.js** - åˆ†äº«é€»è¾‘ï¼ˆæ–°å¢ï¼‰
3. âœ… **config/nginx.conf** - Nginxé…ç½®æ¨¡æ¿ï¼ˆå·²æ›´æ–°ï¼‰

### éœ€è¦ä¿®æ”¹ä½†æš‚æœªä¿®æ”¹çš„æ–‡ä»¶

4. âš ï¸ **backend/main.py** - éœ€è¦å›é€€éƒ¨åˆ†ä¿®æ”¹ï¼ˆè§ä¸‹æ–‡ï¼‰

## ğŸ”§ é‡è¦è¯´æ˜ï¼šbackend/main.py éœ€è¦è°ƒæ•´

ç”±äºä½ ä½¿ç”¨çš„æ˜¯ **Nginx** è€Œä¸æ˜¯ FastAPI æä¾›é™æ€æ–‡ä»¶ï¼Œä¹‹å‰å¯¹ `backend/main.py` çš„éƒ¨åˆ†ä¿®æ”¹éœ€è¦**åˆ é™¤**ã€‚

### âŒ éœ€è¦åˆ é™¤çš„ä»£ç 

æ‰“å¼€ `backend/main.py`ï¼Œ**åˆ é™¤**ä»¥ä¸‹å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼š

```python
# åˆ é™¤è¿™äº›importï¼ˆå¦‚æœæ·»åŠ äº†ï¼‰
from fastapi.staticfiles import StaticFiles

# åˆ é™¤è¿™äº›é™æ€æ–‡ä»¶æŒ‚è½½
app.mount("/css", StaticFiles(directory="../frontend/css"), name="css")
app.mount("/js", StaticFiles(directory="../frontend/js"), name="js")

# åˆ é™¤è¿™äº›è·¯ç”±
@app.get("/share/{share_code}")
async def share_page(share_code: str):
    """åˆ†äº«é¡µé¢è·¯ç”±"""
    share_html = Path("../frontend/share.html")
    if share_html.exists():
        return FileResponse(share_html)
    raise HTTPException(status_code=404, detail="é¡µé¢ä¸å­˜åœ¨")

@app.get("/")
async def root():
    """æ ¹è·¯å¾„é‡å®šå‘åˆ°å‰ç«¯é¦–é¡µ"""
    index_html = Path("../frontend/index.html")
    if index_html.exists():
        return FileResponse(index_html)
    raise HTTPException(status_code=404, detail="é¡µé¢ä¸å­˜åœ¨")
```

### âœ… éœ€è¦ä¿ç•™çš„ä¿®æ”¹

ä¿ç•™åŠ¨æ€åŸŸåç”Ÿæˆçš„ä¿®æ”¹ï¼š

```python
# åœ¨å¯¼å…¥éƒ¨åˆ†ï¼Œç¡®ä¿æœ‰ Request
from fastapi import FastAPI, Depends, HTTPException, status, File as FastAPIFile, UploadFile, Form, Request

# åœ¨ create_share å‡½æ•°ä¸­
@app.post("/api/shares/create", response_model=ShareResponse)
async def create_share(
    request: Request,  # â† ä¿ç•™è¿™ä¸ªå‚æ•°
    share_data: ShareCreate,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    # ...
    
    # ä¿ç•™è¿™éƒ¨åˆ†ï¼ˆåŠ¨æ€è·å–åŸŸåï¼‰
    host = request.headers.get("host", "localhost:8000")
    scheme = request.url.scheme
    base_url = f"{scheme}://{host}"
    share_url = f"{base_url}/share/{share.share_code}"
    
    # ...
```

## ğŸš€ å®Œæ•´æ›´æ–°æµç¨‹ï¼ˆ5æ­¥ï¼‰

### ç¬¬1æ­¥ï¼šåœ¨Windowsä¸Šè°ƒæ•´ä»£ç 

```powershell
# åœ¨ Windows PowerShell ä¸­
cd F:\Github\RaspiOwnCloud

# ç¼–è¾‘ backend/main.pyï¼Œåˆ é™¤é™æ€æ–‡ä»¶ç›¸å…³ä»£ç ï¼ˆè§ä¸Šæ–‡ï¼‰
notepad backend\main.py
```

### ç¬¬2æ­¥ï¼šæäº¤åˆ°Gitï¼ˆå¯é€‰ä½†æ¨èï¼‰

```powershell
git add .
git commit -m "ä¿®å¤åˆ†äº«åŠŸèƒ½ - æ·»åŠ åˆ†äº«é¡µé¢å’ŒNginxè·¯ç”±é…ç½®"
git push origin main
```

### ç¬¬3æ­¥ï¼šSSHåˆ°æ ‘è“æ´¾å¹¶æ‹‰å–ä»£ç 

```bash
# SSHç™»å½•æ ‘è“æ´¾
ssh pi@raspberrypi.local

# è¿›å…¥æ›´æ–°æ–‡ä»¶å¤¹
cd ~/Desktop/Github/RaspiOwnCloud

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main
```

### ç¬¬4æ­¥ï¼šè¿è¡Œæ›´æ–°è„šæœ¬

```bash
# åœ¨æ ‘è“æ´¾çš„æ›´æ–°æ–‡ä»¶å¤¹ä¸­æ‰§è¡Œ
cd ~/Desktop/Github/RaspiOwnCloud
bash scripts/quick_update.sh
```

è¿™ä¼šè‡ªåŠ¨ï¼š
- å¤åˆ¶å‰ç«¯æ–‡ä»¶åˆ° `/var/www/raspberrycloud/`
- å¤åˆ¶åç«¯æ–‡ä»¶åˆ° `/opt/raspberrycloud/backend/`
- é‡å¯FastAPIæœåŠ¡

### ç¬¬5æ­¥ï¼šæ›´æ–°Nginxé…ç½®å¹¶é‡è½½

```bash
# ç¼–è¾‘Nginxé…ç½®
sudo nano /etc/nginx/sites-available/raspberrycloud

# åœ¨ "# å‰ç«¯é™æ€æ–‡ä»¶" ä¹‹å‰æ·»åŠ ï¼š
# 
#     # åˆ†äº«é¡µé¢è·¯ç”±
#     location ~ ^/share/[a-zA-Z0-9]+$ {
#         root /var/www/raspberrycloud;
#         try_files /share.html =404;
#     }

# ä¿å­˜é€€å‡ºåï¼Œæµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½Nginx
sudo systemctl reload nginx
```

## âœ… éªŒè¯æ›´æ–°

```bash
# 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh /var/www/raspberrycloud/share.html
ls -lh /var/www/raspberrycloud/js/share.js

# 2. æ£€æŸ¥Nginxé…ç½®
grep "location ~ \^/share/" /etc/nginx/sites-available/raspberrycloud

# 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status nginx
sudo systemctl status raspberrycloud

# 4. æµ‹è¯•åˆ†äº«é¡µé¢
curl -I http://localhost/share/test123
# åº”è¯¥è¿”å› 200 OK
```

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

1. æµè§ˆå™¨è®¿é—®ä½ çš„äº‘ç›˜
2. ç™»å½•è´¦å·
3. é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼Œç‚¹å‡»"åˆ†äº«"
4. åˆ›å»ºåˆ†äº«å¹¶å¤åˆ¶é“¾æ¥
5. åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€åˆ†äº«é“¾æ¥
6. âœ… åº”è¯¥çœ‹åˆ°åˆ†äº«é¡µé¢ï¼Œå¯ä»¥ä¸‹è½½æ–‡ä»¶

## ğŸ” å¿«é€Ÿæ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šåˆ†äº«é“¾æ¥æ˜¾ç¤º404

```bash
# æ£€æŸ¥share.htmlæ˜¯å¦å­˜åœ¨
ls -lh /var/www/raspberrycloud/share.html

# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t
grep "share" /etc/nginx/sites-available/raspberrycloud

# é‡æ–°éƒ¨ç½²
cd ~/Desktop/Github/RaspiOwnCloud
bash scripts/quick_update.sh
sudo systemctl reload nginx
```

### é—®é¢˜ï¼šAPIè¯·æ±‚å¤±è´¥

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
sudo systemctl status raspberrycloud
sudo journalctl -u raspberrycloud -n 50

# é‡å¯åç«¯
sudo systemctl restart raspberrycloud
```

## ğŸ“Š æ¶æ„æµç¨‹å›¾

```
ç”¨æˆ·è®¿é—®: http://your-ip/share/abc123
    â†“
Nginx (:80)
    â”œâ”€ åŒ¹é…: location ~ ^/share/[a-zA-Z0-9]+$
    â”œâ”€ è¿”å›: /var/www/raspberrycloud/share.html
    â””â”€ share.html åŠ è½½ share.js
          â†“
    share.js è°ƒç”¨: /api/shares/info/abc123
          â†“
    Nginx ä»£ç†åˆ°: FastAPI (:8000)
          â†“
    FastAPI è¿”å›æ–‡ä»¶ä¿¡æ¯
          â†“
    æ˜¾ç¤ºåˆ†äº«é¡µé¢ï¼ˆæ–‡ä»¶ä¿¡æ¯ + ä¸‹è½½æŒ‰é’®ï¼‰
```

## ğŸ“ å…³é”®å‘½ä»¤é€ŸæŸ¥

```bash
# === æ›´æ–°ä»£ç  ===
cd ~/Desktop/Github/RaspiOwnCloud
git pull origin main
bash scripts/quick_update.sh

# === æ›´æ–°Nginx ===
sudo nano /etc/nginx/sites-available/raspberrycloud
sudo nginx -t
sudo systemctl reload nginx

# === æŸ¥çœ‹çŠ¶æ€ ===
sudo systemctl status nginx
sudo systemctl status raspberrycloud

# === æŸ¥çœ‹æ—¥å¿— ===
sudo journalctl -u raspberrycloud -f
sudo tail -f /var/log/nginx/raspberrycloud_access.log
```

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

1. âœ… **å‰ç«¯æ–‡ä»¶** â†’ Nginxæä¾› (`/var/www/raspberrycloud/`)
2. âœ… **APIè¯·æ±‚** â†’ FastAPIå¤„ç† (`:8000`)
3. âœ… **åˆ†äº«è·¯ç”±** â†’ Nginxç‰¹æ®Šè§„åˆ™
4. âŒ **ä¸éœ€è¦åœ¨FastAPIä¸­æŒ‚è½½é™æ€æ–‡ä»¶**ï¼ˆå› ä¸ºæœ‰Nginxï¼‰

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- [åˆ†äº«åŠŸèƒ½-Nginxæ¶æ„æ›´æ–°æŒ‡å—.md](åˆ†äº«åŠŸèƒ½-Nginxæ¶æ„æ›´æ–°æŒ‡å—.md) - è¶…è¯¦ç»†ç‰ˆæœ¬
- [å¿«é€Ÿæµ‹è¯•-åˆ†äº«åŠŸèƒ½.md](å¿«é€Ÿæµ‹è¯•-åˆ†äº«åŠŸèƒ½.md) - åŠŸèƒ½æµ‹è¯•æŒ‡å—
- [åˆ†äº«åŠŸèƒ½ä¿®å¤è¯´æ˜.md](åˆ†äº«åŠŸèƒ½ä¿®å¤è¯´æ˜.md) - æŠ€æœ¯è¯´æ˜

---

**å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·å‚è€ƒè¯¦ç»†æ–‡æ¡£æˆ–æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼** ğŸ‰




