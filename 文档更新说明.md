# 文档更新说明 - 双文件夹部署架构

## 📋 更新概述

本次更新将项目部署方式改为**双文件夹部署架构**，这是生产环境的最佳实践。

## 🎯 核心变化

### 部署架构

**之前**：单文件夹部署
- 所有操作在 `/opt/raspberrycloud/` 进行
- Git和运行混在一起，容易出现权限问题

**现在**：双文件夹部署 ⭐
- **更新文件夹**：`~/Desktop/Github/RaspiOwnCloud/` - 用于Git操作
- **生产文件夹**：`/opt/raspberrycloud/` - 用于服务运行
- 权限分离，工作流程更清晰

## 📝 修改的文件

### 1. 核心文档

#### `README.md`
- ✅ 添加双文件夹架构说明
- ✅ 更新快速开始部分
- ✅ 更新运行项目部分
- ✅ 添加文件夹说明
- ✅ 更新文档导航

#### `docs/02-系统部署教程.md`
- ✅ 重写"步骤2：下载项目代码"部分
- ✅ 明确更新文件夹和生产文件夹的概念
- ✅ 更新后续更新流程
- ✅ 调整Python环境配置说明

### 2. 部署脚本

#### `scripts/update_from_github.sh`
- ✅ 更新脚本注释，说明双文件夹架构
- ✅ 修改逻辑：从更新文件夹拉取，复制到生产文件夹
- ✅ 明确区分 UPDATE_DIR 和 PROD_DIR
- ✅ 优化权限设置

#### `scripts/quick_update.sh`
- ✅ 更新脚本注释
- ✅ 修改逻辑支持双文件夹
- ✅ 改进输出信息，更清晰

#### `scripts/initial_deploy.sh` (新建)
- ✅ 创建初始部署脚本
- ✅ 自动创建生产目录结构
- ✅ 从更新文件夹复制文件
- ✅ 配置虚拟环境和依赖
- ✅ 配置systemd和Nginx

### 3. 新增文档

#### `docs/双文件夹部署架构说明.md` (新建)
- ✅ 详细说明双文件夹架构
- ✅ 架构图示
- ✅ 优势说明
- ✅ 完整工作流程
- ✅ 常用操作
- ✅ 故障排查
- ✅ 最佳实践

#### `docs/快速参考-双文件夹部署.md` (新建)
- ✅ 快速参考卡片
- ✅ 常用命令速查
- ✅ 工作流程图
- ✅ 快速故障排查

## 🚀 新的部署流程

### 首次部署

```bash
# 1. 创建更新文件夹
mkdir -p ~/Desktop/Github
cd ~/Desktop/Github
git clone https://github.com/lyf-workshop/RaspiOwnCloud.git
cd RaspiOwnCloud

# 2. 运行初始部署脚本
sudo bash scripts/initial_deploy.sh

# 3. 配置环境变量
sudo nano /opt/raspberrycloud/backend/.env
```

### 日常更新

```bash
# 1. 在更新文件夹拉取代码
cd ~/Desktop/Github/RaspiOwnCloud
git pull origin main

# 2. 快速部署
bash scripts/quick_update.sh
```

## 📊 文件结构对比

### 之前
```
/opt/raspberrycloud/
├── .git/              ← Git仓库（权限问题）
├── backend/
├── frontend/
└── venv/
```

### 现在
```
更新文件夹：~/Desktop/Github/RaspiOwnCloud/
├── .git/              ← Git仓库
├── backend/           ← 源代码
├── frontend/
├── scripts/           ← 部署脚本
└── docs/

生产文件夹：/opt/raspberrycloud/
├── backend/           ← 运行代码
├── frontend/
├── venv/              ← Python环境
└── backend/.env       ← 配置文件
```

## ✨ 优势

1. **权限分离**
   - 更新文件夹：普通用户权限
   - 生产文件夹：www-data权限
   - 避免Git权限问题

2. **安全性提升**
   - 生产环境不包含.git目录
   - 配置文件权限更严格
   - 服务以最小权限运行

3. **更新更安全**
   - 拉取代码不影响运行中的服务
   - 可以先测试再部署
   - 自动备份机制

4. **工作流程清晰**
   - 开发/更新：在更新文件夹
   - 部署：运行脚本
   - 运行：从生产文件夹

## 📚 文档导航

### 必读文档
1. [双文件夹部署架构说明](docs/双文件夹部署架构说明.md) - 详细说明
2. [快速参考-双文件夹部署](docs/快速参考-双文件夹部署.md) - 速查手册
3. [系统部署教程](docs/02-系统部署教程.md) - 完整部署流程

### 部署脚本
- `scripts/initial_deploy.sh` - 首次部署
- `scripts/quick_update.sh` - 日常更新（推荐）
- `scripts/update_from_github.sh` - 完整更新（带备份）

## ⚠️ 迁移指南（已有部署的用户）

如果你已经部署了旧版本，需要迁移到双文件夹架构：

```bash
# 1. 创建更新文件夹
mkdir -p ~/Desktop/Github
cd ~/Desktop/Github
git clone https://github.com/lyf-workshop/RaspiOwnCloud.git

# 2. 备份当前生产环境
sudo cp -r /opt/raspberrycloud /opt/raspberrycloud_backup_$(date +%Y%m%d)

# 3. 备份配置文件
sudo cp /opt/raspberrycloud/backend/.env ~/raspberrycloud.env.backup

# 4. 如果生产目录有.git，可以删除（可选）
sudo rm -rf /opt/raspberrycloud/.git

# 5. 恢复配置文件
sudo cp ~/raspberrycloud.env.backup /opt/raspberrycloud/backend/.env

# 6. 后续使用新的更新流程
cd ~/Desktop/Github/RaspiOwnCloud
git pull origin main
bash scripts/quick_update.sh
```

## 🎉 总结

本次更新将部署架构升级为双文件夹模式，这是生产环境的最佳实践。主要优势：

- ✅ 权限分离，更安全
- ✅ 更新不影响运行
- ✅ 避免Git权限问题
- ✅ 工作流程更清晰
- ✅ 符合行业标准

建议所有用户采用新的部署方式！


