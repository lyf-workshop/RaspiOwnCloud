# ç³»ç»Ÿéƒ¨ç½²æ•™ç¨‹

å®Œæ•´çš„åç«¯ã€å‰ç«¯ã€æ•°æ®åº“ã€WebæœåŠ¡å™¨éƒ¨ç½²æŒ‡å—ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

ç¡®ä¿å·²å®Œæˆ[ç¡¬ä»¶å‡†å¤‡ä¸åˆå§‹åŒ–](01-ç¡¬ä»¶å‡†å¤‡ä¸åˆå§‹åŒ–.md)ï¼š
- âœ… æ ‘è“æ´¾ç³»ç»Ÿå·²çƒ§å½•å¹¶æ›´æ–°
- âœ… å¤–æ¥å­˜å‚¨å·²æŒ‚è½½åˆ° `/mnt/cloud_storage`
- âœ… é™æ€IPå·²è®¾ç½®
- âœ… SSHå·²å¼€å¯å¹¶å¯è¿æ¥

## ğŸ“¦ æ­¥éª¤1ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–

### 1.1 å®‰è£…Python 3.11+

```bash
# æ£€æŸ¥Pythonç‰ˆæœ¬
python3 --version

# å¦‚æœç‰ˆæœ¬<3.11ï¼Œå®‰è£…æœ€æ–°ç‰ˆ
sudo apt update
sudo apt install -y python3 python3-pip python3-venv

# å®‰è£…å¼€å‘å·¥å…·
sudo apt install -y python3-dev build-essential libssl-dev libffi-dev
```

### 1.2 å®‰è£…æ•°æ®åº“

#### é€‰é¡¹Aï¼šSQLiteï¼ˆæ¨èï¼Œé€‚åˆâ‰¤3ç”¨æˆ·ï¼‰

```bash
# SQLiteå·²é¢„è£…åœ¨Raspberry Pi OS
sqlite3 --version

# å¦‚æœæ²¡æœ‰ï¼Œå®‰è£…ï¼š
sudo apt install -y sqlite3 libsqlite3-dev
```

#### é€‰é¡¹Bï¼šMariaDBï¼ˆé€‚åˆ3+ç”¨æˆ·ï¼‰

```bash
# å®‰è£…MariaDB
sudo apt install -y mariadb-server mariadb-client

# å¯åŠ¨æœåŠ¡
sudo systemctl start mariadb
sudo systemctl enable mariadb

# å®‰å…¨é…ç½®
sudo mysql_secure_installation
# æŒ‰æç¤ºæ“ä½œï¼š
# - è®¾ç½®rootå¯†ç ï¼ˆè®°ä½æ­¤å¯†ç ï¼‰
# - åˆ é™¤åŒ¿åç”¨æˆ·ï¼šY
# - ç¦æ­¢rootè¿œç¨‹ç™»å½•ï¼šY
# - åˆ é™¤æµ‹è¯•æ•°æ®åº“ï¼šY
# - é‡æ–°åŠ è½½æƒé™ï¼šY

# åˆ›å»ºåº”ç”¨æ•°æ®åº“å’Œç”¨æˆ·
sudo mysql -u root -p
```

åœ¨MySQLæç¤ºç¬¦ä¸‹æ‰§è¡Œï¼š

```sql
CREATE DATABASE raspberrycloud CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'clouduser'@'localhost' IDENTIFIED BY 'ä½ çš„å¯†ç ';
GRANT ALL PRIVILEGES ON raspberrycloud.* TO 'clouduser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 1.3 å®‰è£…Nginx

```bash
sudo apt install -y nginx

# å¯åŠ¨æœåŠ¡
sudo systemctl start nginx
sudo systemctl enable nginx

# æµ‹è¯•ï¼ˆæµè§ˆå™¨è®¿é—® http://æ ‘è“æ´¾IPï¼Œåº”æ˜¾ç¤ºNginxæ¬¢è¿é¡µï¼‰
```

### 1.4 å®‰è£…Sambaï¼ˆå±€åŸŸç½‘å…±äº«ï¼‰

```bash
sudo apt install -y samba samba-common-bin

# å¯åŠ¨æœåŠ¡
sudo systemctl start smbd
sudo systemctl enable smbd
```

### 1.5 å®‰è£…å…¶ä»–å·¥å…·

```bash
# å®‰è£…ffmpegï¼ˆè§†é¢‘é¢„è§ˆç¼©ç•¥å›¾ï¼‰
sudo apt install -y ffmpeg

# å®‰è£…å›¾åƒå¤„ç†åº“
sudo apt install -y libjpeg-dev zlib1g-dev

# å®‰è£…supervisorï¼ˆè¿›ç¨‹ç®¡ç†ï¼Œå¯é€‰ï¼‰
sudo apt install -y supervisor
```

## ğŸ§¹ é‡æ–°éƒ¨ç½²å‰çš„æ¸…ç†ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦é‡æ–°éƒ¨ç½²ï¼Œè¯·å…ˆæ¸…ç†ä¹‹å‰çš„éƒ¨ç½²å†…å®¹ï¼š

```bash
# æ–¹æ³•1ï¼šå¦‚æœé¡¹ç›®ç›®å½•è¿˜å­˜åœ¨ï¼Œè¿è¡Œæ¸…ç†è„šæœ¬
sudo bash /opt/raspberrycloud/scripts/cleanup.sh

# æ–¹æ³•2ï¼šå¦‚æœé¡¹ç›®ç›®å½•å·²åˆ é™¤ï¼Œä»Gitä»“åº“è¿è¡Œ
cd /path/to/RaspiOwnCloud
sudo bash scripts/cleanup.sh

# æ–¹æ³•3ï¼šæ‰‹åŠ¨æ¸…ç†ï¼ˆæ¨èï¼Œæ›´å®‰å…¨ï¼‰ï¼š
# 1. åœæ­¢æœåŠ¡
sudo systemctl stop raspberrycloud
sudo systemctl disable raspberrycloud

# 2. åˆ é™¤æœåŠ¡æ–‡ä»¶
sudo rm /etc/systemd/system/raspberrycloud.service
sudo systemctl daemon-reload

# 3. åˆ é™¤é¡¹ç›®ç›®å½•
sudo rm -rf /opt/raspberrycloud

# 4. åˆ é™¤å‰ç«¯æ–‡ä»¶
sudo rm -rf /var/www/raspberrycloud

# 5. åˆ é™¤Nginxé…ç½®
sudo rm /etc/nginx/sites-enabled/raspberrycloud
sudo rm /etc/nginx/sites-available/raspberrycloud
sudo systemctl restart nginx

# 6. åˆ é™¤æ—¥å¿—ç›®å½•
sudo rm -rf /var/log/raspberrycloud
```

**æ³¨æ„**ï¼šæ¸…ç†è„šæœ¬ä¼šä¿ç•™ç”¨æˆ·æ•°æ®ï¼ˆ`/mnt/cloud_storage`ï¼‰ï¼Œå¦‚éœ€å®Œå…¨æ¸…ç†è¯·æ‰‹åŠ¨åˆ é™¤ã€‚

## ğŸ—‚ï¸ æ­¥éª¤2ï¼šå‡†å¤‡é¡¹ç›®ä»£ç ï¼ˆåŒæ–‡ä»¶å¤¹éƒ¨ç½²ï¼‰

### 2.1 éƒ¨ç½²æ¶æ„è¯´æ˜ â­

æœ¬é¡¹ç›®é‡‡ç”¨**åŒæ–‡ä»¶å¤¹éƒ¨ç½²æ¶æ„**ï¼ˆæœ€ä½³å®è·µï¼‰ï¼š

```
ğŸ“ æ›´æ–°æ–‡ä»¶å¤¹ï¼ˆå¼€å‘ç›®å½•ï¼‰
   ~/Desktop/Github/RaspiOwnCloud/
   â”œâ”€â”€ ç”¨é€”ï¼šä»GitHubä¸‹è½½å’Œæ›´æ–°ä»£ç 
   â”œâ”€â”€ æƒé™ï¼šæ™®é€šç”¨æˆ·ï¼ˆpiï¼‰å¯è¯»å†™
   â””â”€â”€ æ“ä½œï¼šgit pull, ä»£ç ä¿®æ”¹

        â†“ éƒ¨ç½²è„šæœ¬å¤åˆ¶

ğŸ“ ç”Ÿäº§æ–‡ä»¶å¤¹ï¼ˆè¿è¡Œç›®å½•ï¼‰
   /opt/raspberrycloud/
   â”œâ”€â”€ ç”¨é€”ï¼šå®é™…è¿è¡Œçš„æœåŠ¡ä»£ç 
   â”œâ”€â”€ æƒé™ï¼šwww-dataç”¨æˆ·ï¼ˆæœåŠ¡è¿è¡Œèº«ä»½ï¼‰
   â””â”€â”€ æ“ä½œï¼šsystemdæœåŠ¡è¯»å–è¿è¡Œ
```

**ä¼˜åŠ¿**ï¼š
- âœ… æƒé™åˆ†ç¦»ï¼Œæ›´å®‰å…¨
- âœ… æ›´æ–°æ—¶ä¸å½±å“è¿è¡Œä¸­çš„æœåŠ¡
- âœ… å¯ä»¥æµ‹è¯•åå†éƒ¨ç½²
- âœ… é¿å…Gitæƒé™é—®é¢˜

### 2.2 åˆ›å»ºæ›´æ–°æ–‡ä»¶å¤¹ï¼ˆå¼€å‘ç›®å½•ï¼‰

```bash
# 1. åˆ›å»ºå¼€å‘ç›®å½•
mkdir -p ~/Desktop/Github
cd ~/Desktop/Github

# 2. ä»GitHubå…‹éš†é¡¹ç›®
git clone https://github.com/lyf-workshop/RaspiOwnCloud.git
cd RaspiOwnCloud

# 3. éªŒè¯æ–‡ä»¶ç»“æ„
ls -la
# åº”è¯¥çœ‹åˆ°ï¼šbackend/ frontend/ config/ scripts/ docs/ README.md
```

### 2.3 åˆ›å»ºç”Ÿäº§æ–‡ä»¶å¤¹ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰

```bash
# 1. åˆ›å»ºç”Ÿäº§ç›®å½•
sudo mkdir -p /opt/raspberrycloud

# 2. ä»å¼€å‘ç›®å½•å¤åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§ç›®å½•
cd ~/Desktop/Github/RaspiOwnCloud
sudo cp -r backend frontend config scripts docs /opt/raspberrycloud/

# 3. è®¾ç½®ç”Ÿäº§ç›®å½•æƒé™ï¼ˆé‡è¦ï¼ï¼‰
sudo chown -R www-data:www-data /opt/raspberrycloud
sudo chmod -R 755 /opt/raspberrycloud

# 4. éªŒè¯ç”Ÿäº§ç›®å½•
ls -la /opt/raspberrycloud
```

### 2.4 åç»­æ›´æ–°æµç¨‹

**æ—¥å¸¸æ›´æ–°ä»£ç çš„æ ‡å‡†æµç¨‹ï¼š**

```bash
# æ­¥éª¤1ï¼šåœ¨æ›´æ–°æ–‡ä»¶å¤¹æ‹‰å–æœ€æ–°ä»£ç 
cd ~/Desktop/Github/RaspiOwnCloud
git pull origin main

# æ­¥éª¤2ï¼šä½¿ç”¨å¿«é€Ÿæ›´æ–°è„šæœ¬éƒ¨ç½²åˆ°ç”Ÿäº§æ–‡ä»¶å¤¹
bash scripts/quick_update.sh

# æˆ–ä½¿ç”¨å®Œæ•´æ›´æ–°è„šæœ¬ï¼ˆå¸¦å¤‡ä»½ï¼‰
sudo bash scripts/update_from_github.sh
```

**è„šæœ¬è‡ªåŠ¨å®Œæˆçš„æ“ä½œï¼š**
1. åœæ­¢æœåŠ¡
2. å¤‡ä»½å½“å‰ç”Ÿäº§ä»£ç ï¼ˆå¯é€‰ï¼‰
3. ä»æ›´æ–°æ–‡ä»¶å¤¹å¤åˆ¶åˆ°ç”Ÿäº§æ–‡ä»¶å¤¹
4. æ›´æ–°Pythonä¾èµ–ï¼ˆå¯é€‰ï¼‰
5. é‡å¯æœåŠ¡
6. æ£€æŸ¥æœåŠ¡çŠ¶æ€

### 2.5 éªŒè¯æ–‡ä»¶ç»“æ„

```bash
# éªŒè¯æ›´æ–°æ–‡ä»¶å¤¹
ls -la ~/Desktop/Github/RaspiOwnCloud
# åº”è¯¥çœ‹åˆ°ï¼šbackend/ frontend/ config/ scripts/ docs/ .git/

# éªŒè¯ç”Ÿäº§æ–‡ä»¶å¤¹
ls -la /opt/raspberrycloud
# åº”è¯¥çœ‹åˆ°ï¼šbackend/ frontend/ config/ scripts/ docs/
# æ³¨æ„ï¼šç”Ÿäº§æ–‡ä»¶å¤¹ä¸éœ€è¦.gitç›®å½•

# æ£€æŸ¥æƒé™
ls -l /opt/raspberrycloud
# åº”è¯¥æ˜¾ç¤ºæ‰€æœ‰è€…ä¸º www-data:www-data
```

## ğŸ æ­¥éª¤3ï¼šéƒ¨ç½²åç«¯æœåŠ¡ï¼ˆåœ¨ç”Ÿäº§æ–‡ä»¶å¤¹ï¼‰

### 3.1 åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ

```bash
# è¿›å…¥ç”Ÿäº§ç›®å½•
cd /opt/raspberrycloud

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆéœ€è¦sudoï¼Œå› ä¸ºç›®å½•å±äºwww-dataï¼‰
sudo python3 -m venv venv

# è®¾ç½®è™šæ‹Ÿç¯å¢ƒæƒé™
sudo chown -R www-data:www-data /opt/raspberrycloud/venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆä¸´æ—¶åˆ‡æ¢åˆ°www-dataç”¨æˆ·ï¼‰
sudo -u www-data bash -c "source /opt/raspberrycloud/venv/bin/activate && pip install --upgrade pip"
```

### 3.2 å®‰è£…Pythonä¾èµ–

```bash
# è¿›å…¥ç”Ÿäº§ç›®å½•çš„backendæ–‡ä»¶å¤¹
cd /opt/raspberrycloud/backend

# ä½¿ç”¨www-dataç”¨æˆ·å®‰è£…ä¾èµ–ï¼ˆéœ€è¦5-10åˆ†é’Ÿï¼‰
sudo -u www-data bash -c "source /opt/raspberrycloud/venv/bin/activate && pip install -r requirements.txt"

# å¦‚æœå®‰è£…å¤±è´¥ï¼Œå°è¯•å•ç‹¬å®‰è£…ï¼š
sudo -u www-data bash -c "source /opt/raspberrycloud/venv/bin/activate && \
  pip install fastapi==0.104.1 && \
  pip install uvicorn[standard]==0.24.0 && \
  pip install python-multipart==0.0.6 && \
  pip install aiofiles==23.2.1 && \
  pip install python-jose[cryptography]==3.3.0 && \
  pip install passlib[bcrypt]==1.7.4 && \
  pip install sqlalchemy==2.0.23 && \
  pip install alembic==1.12.1 && \
  pip install pillow==10.1.0 && \
  pip install python-magic==0.4.27"
```

### 3.3 é…ç½®ç¯å¢ƒå˜é‡

```bash
# ä»æ›´æ–°æ–‡ä»¶å¤¹å¤åˆ¶é…ç½®æ¨¡æ¿åˆ°ç”Ÿäº§ç›®å½•
sudo cp ~/Desktop/Github/RaspiOwnCloud/config/env.example /opt/raspberrycloud/backend/.env

# è®¾ç½®æƒé™
sudo chown www-data:www-data /opt/raspberrycloud/backend/.env
sudo chmod 600 /opt/raspberrycloud/backend/.env

# ç¼–è¾‘é…ç½®
sudo nano /opt/raspberrycloud/backend/.env
```

é…ç½®å†…å®¹ï¼š

```bash
# åº”ç”¨é…ç½®
APP_NAME=RaspberryCloud
APP_VERSION=1.0.0
DEBUG=false

# å®‰å…¨é…ç½®
SECRET_KEY=ä½ çš„éšæœºå¯†é’¥ï¼ˆä½¿ç”¨ä¸‹é¢å‘½ä»¤ç”Ÿæˆï¼‰
# ç”Ÿæˆå¯†é’¥ï¼šopenssl rand -hex 32
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# æ•°æ®åº“é…ç½®ï¼ˆSQLiteï¼‰
DATABASE_URL=sqlite:////opt/raspberrycloud/backend/raspberrycloud.db

# æˆ–ä½¿ç”¨MariaDB
# DATABASE_URL=mysql+pymysql://clouduser:ä½ çš„å¯†ç @localhost/raspberrycloud

# å­˜å‚¨é…ç½®
STORAGE_PATH=/mnt/cloud_storage/users
SHARE_PATH=/mnt/cloud_storage/shares
TEMP_PATH=/mnt/cloud_storage/temp
BACKUP_PATH=/mnt/cloud_storage/backups

# æ–‡ä»¶é™åˆ¶
MAX_FILE_SIZE=10737418240  # 10GB in bytes
MAX_UPLOAD_THREADS=5

# é»˜è®¤ç®¡ç†å‘˜
ADMIN_USERNAME=admin
ADMIN_PASSWORD=RaspberryCloud2024!
ADMIN_EMAIL=admin@raspberrycloud.local
```

ç”Ÿæˆå¯†é’¥ï¼š

```bash
openssl rand -hex 32
# å°†è¾“å‡ºå¤åˆ¶åˆ°.envçš„SECRET_KEY
```

### 3.4 åˆå§‹åŒ–æ•°æ®åº“

```bash
cd /opt/raspberrycloud/backend

# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
source /opt/raspberrycloud/venv/bin/activate

# è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
python -c "from models import init_db; init_db()"

# æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQLï¼ˆå¦‚æœä½¿ç”¨SQLiteï¼‰
sqlite3 raspberrycloud.db < database.sql
```

### 3.5 æµ‹è¯•åç«¯æœåŠ¡

```bash
cd /opt/raspberrycloud/backend
source /opt/raspberrycloud/venv/bin/activate

# å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
uvicorn main:app --host 0.0.0.0 --port 8000

# æ‰“å¼€å¦ä¸€ä¸ªSSHä¼šè¯æµ‹è¯•
curl http://localhost:8000/api/health

# é¢„æœŸè¾“å‡ºï¼š{"status":"healthy","version":"1.0.0"}

# æµ‹è¯•å®ŒæˆåæŒ‰ Ctrl+C åœæ­¢
```

## ğŸŒ æ­¥éª¤4ï¼šéƒ¨ç½²å‰ç«¯

### 4.1 å¤åˆ¶å‰ç«¯æ–‡ä»¶

```bash
# åˆ›å»ºWebæ ¹ç›®å½•
sudo mkdir -p /var/www/raspberrycloud

# å¤åˆ¶å‰ç«¯æ–‡ä»¶
sudo cp -r /opt/raspberrycloud/frontend/* /var/www/raspberrycloud/

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/raspberrycloud
sudo chmod -R 755 /var/www/raspberrycloud
```

### 4.2 é…ç½®å‰ç«¯APIåœ°å€

```bash
sudo nano /var/www/raspberrycloud/js/config.js
```

å†…å®¹ï¼š

```javascript
const API_BASE_URL = window.location.protocol + '//' + window.location.host + '/api';
const WS_BASE_URL = (window.location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + window.location.host + '/ws';
const MAX_FILE_SIZE = 10 * 1024 * 1024 * 1024; // 10GB
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB åˆ†å—ä¸Šä¼ 
```

## ğŸ”§ æ­¥éª¤5ï¼šé…ç½®Nginx

### 5.1 å¤‡ä»½é»˜è®¤é…ç½®

```bash
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup
```

### 5.2 åˆ›å»ºåº”ç”¨é…ç½®

```bash
sudo nano /etc/nginx/sites-available/raspberrycloud
```

åŸºç¡€é…ç½®ï¼ˆHTTPï¼Œåç»­ä¼šå‡çº§åˆ°HTTPSï¼‰ï¼š

```nginx
# ä¸Šæ¸¸åç«¯æœåŠ¡
upstream backend {
    server 127.0.0.1:8000;
}

# HTTPæœåŠ¡å™¨
server {
    listen 80;
    listen [::]:80;
    server_name _;  # åç»­æ›¿æ¢ä¸ºä½ çš„åŸŸå

    # å®¢æˆ·ç«¯æœ€å¤§è¯·æ±‚ä½“ï¼ˆå…è®¸å¤§æ–‡ä»¶ä¸Šä¼ ï¼‰
    client_max_body_size 10G;
    client_body_buffer_size 128k;
    client_body_timeout 3600s;
    
    # ä»£ç†è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/raspberrycloud;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # é™æ€èµ„æºç¼“å­˜
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # APIä»£ç†åˆ°åç«¯
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ 
        proxy_request_buffering off;
    }

    # WebSocketä»£ç†ï¼ˆæ–‡ä»¶åŒæ­¥ï¼‰
    location /ws/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # æ—¥å¿—
    access_log /var/log/nginx/raspberrycloud_access.log;
    error_log /var/log/nginx/raspberrycloud_error.log;
}
```

### 5.3 å¯ç”¨é…ç½®

```bash
# åˆ›å»ºè½¯é“¾æ¥
sudo ln -s /etc/nginx/sites-available/raspberrycloud /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é¢„æœŸè¾“å‡ºï¼š
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# é‡å¯Nginx
sudo systemctl restart nginx
```

## ğŸš€ æ­¥éª¤6ï¼šé…ç½®ç³»ç»ŸæœåŠ¡ï¼ˆå¼€æœºè‡ªå¯ï¼‰

### 6.1 åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶

```bash
sudo nano /etc/systemd/system/raspberrycloud.service
```

å†…å®¹ï¼š

```ini
[Unit]
Description=RaspberryCloud Private Cloud Storage Service
After=network.target mysql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/raspberrycloud/backend
Environment="PATH=/opt/raspberrycloud/venv/bin"
ExecStart=/opt/raspberrycloud/venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000 --workers 2

# è‡ªåŠ¨é‡å¯
Restart=always
RestartSec=10

# èµ„æºé™åˆ¶
LimitNOFILE=65536
MemoryLimit=512M

# æ—¥å¿—
StandardOutput=append:/var/log/raspberrycloud/backend.log
StandardError=append:/var/log/raspberrycloud/backend_error.log

[Install]
WantedBy=multi-user.target
```

### 6.2 åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
sudo mkdir -p /var/log/raspberrycloud
sudo chown -R www-data:www-data /var/log/raspberrycloud
```

### 6.3 å¯åŠ¨æœåŠ¡

```bash
# é‡æ–°åŠ è½½systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start raspberrycloud

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status raspberrycloud

# é¢„æœŸè¾“å‡ºï¼š
# â— raspberrycloud.service - RaspberryCloud Private Cloud Storage Service
#    Loaded: loaded (/etc/systemd/system/raspberrycloud.service; disabled)
#    Active: active (running) since ...

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable raspberrycloud
```

### 6.4 ç®¡ç†æœåŠ¡å‘½ä»¤

```bash
# å¯åŠ¨
sudo systemctl start raspberrycloud

# åœæ­¢
sudo systemctl stop raspberrycloud

# é‡å¯
sudo systemctl restart raspberrycloud

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status raspberrycloud

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u raspberrycloud -f  # å®æ—¶æ—¥å¿—
sudo journalctl -u raspberrycloud --since "10 minutes ago"  # æœ€è¿‘10åˆ†é’Ÿ
tail -f /var/log/raspberrycloud/backend.log  # åº”ç”¨æ—¥å¿—
```

## ğŸ“ æ­¥éª¤7ï¼šé…ç½®Sambaï¼ˆå±€åŸŸç½‘å…±äº«ï¼‰

### 7.1 é…ç½®Samba

```bash
# å¤‡ä»½é…ç½®
sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.backup

# ç¼–è¾‘é…ç½®
sudo nano /etc/samba/smb.conf
```

åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ï¼š

```ini
[cloud]
   comment = RaspberryCloud Storage
   path = /mnt/cloud_storage/users
   browseable = yes
   writable = yes
   valid users = @cloud-users
   create mask = 0664
   directory mask = 0775
   force user = www-data
   force group = www-data
```

### 7.2 åˆ›å»ºSambaç”¨æˆ·

```bash
# åˆ›å»ºç³»ç»Ÿç”¨æˆ·ç»„
sudo groupadd cloud-users

# æ·»åŠ www-dataåˆ°ç»„
sudo usermod -aG cloud-users www-data

# ä¸ºç®¡ç†å‘˜åˆ›å»ºSambaå¯†ç 
sudo smbpasswd -a $USER
# è¾“å…¥Sambaå¯†ç ï¼ˆå¯ä¸ç³»ç»Ÿå¯†ç ä¸åŒï¼‰

# æ·»åŠ ç”¨æˆ·åˆ°cloud-usersç»„
sudo usermod -aG cloud-users $USER
```

### 7.3 é‡å¯Samba

```bash
# æµ‹è¯•é…ç½®
testparm

# é‡å¯æœåŠ¡
sudo systemctl restart smbd
sudo systemctl restart nmbd
```

### 7.4 æµ‹è¯•Sambaè®¿é—®

**Windowsè®¿é—®ï¼š**
- æ‰“å¼€æ–‡ä»¶èµ„æºç®¡ç†å™¨
- åœ°å€æ è¾“å…¥ï¼š`\\æ ‘è“æ´¾IP\cloud`
- è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 

**Macè®¿é—®ï¼š**
- Finder â†’ å‰å¾€ â†’ è¿æ¥æœåŠ¡å™¨
- è¾“å…¥ï¼š`smb://æ ‘è“æ´¾IP/cloud`

**Linuxè®¿é—®ï¼š**
```bash
smbclient //æ ‘è“æ´¾IP/cloud -U ç”¨æˆ·å
```

## ğŸ§ª æ­¥éª¤8ï¼šå…¨é¢æµ‹è¯•

### 8.1 æµ‹è¯•åç«¯API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost/api/health

# æµ‹è¯•ç™»å½•
curl -X POST http://localhost/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"RaspberryCloud2024!"}'

# åº”è¿”å›JWT token
```

### 8.2 æµ‹è¯•Webç•Œé¢

1. æµè§ˆå™¨è®¿é—®ï¼š`http://æ ‘è“æ´¾IP`
2. åº”è¯¥çœ‹åˆ°ç™»å½•é¡µé¢
3. ä½¿ç”¨é»˜è®¤è´¦æˆ·ç™»å½•ï¼š
   - ç”¨æˆ·åï¼šadmin
   - å¯†ç ï¼šRaspberryCloud2024!
4. æµ‹è¯•åŠŸèƒ½ï¼š
   - ä¸Šä¼ å°æ–‡ä»¶ï¼ˆ<10MBï¼‰
   - åˆ›å»ºæ–‡ä»¶å¤¹
   - æ–‡ä»¶é‡å‘½å
   - æ–‡ä»¶åˆ é™¤
   - æ–‡ä»¶é¢„è§ˆ

### 8.3 æ€§èƒ½æµ‹è¯•

```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æºå ç”¨
htop

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç£ç›˜I/O
iostat -x 1

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
ss -tunlp | grep -E '(8000|80|443)'
```

## ğŸ“Š æ­¥éª¤9ï¼šç›‘æ§ä¸æ—¥å¿—

### 9.1 è®¾ç½®æ—¥å¿—è½®è½¬

```bash
sudo nano /etc/logrotate.d/raspberrycloud
```

å†…å®¹ï¼š

```
/var/log/raspberrycloud/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
    sharedscripts
    postrotate
        systemctl reload raspberrycloud > /dev/null 2>&1 || true
    endscript
}
```

### 9.2 åˆ›å»ºç›‘æ§è„šæœ¬ï¼ˆå¯é€‰ï¼‰

```bash
sudo nano /opt/raspberrycloud/scripts/monitor.sh
```

å†…å®¹ï¼š

```bash
#!/bin/bash
# RaspberryCloudç›‘æ§è„šæœ¬

echo "=== RaspberryCloudçŠ¶æ€ ==="
echo "æ—¶é—´: $(date)"
echo ""

# æœåŠ¡çŠ¶æ€
echo "åç«¯æœåŠ¡:"
systemctl is-active raspberrycloud

echo "NginxçŠ¶æ€:"
systemctl is-active nginx

echo ""
echo "=== èµ„æºä½¿ç”¨ ==="
echo "å†…å­˜:"
free -h | grep Mem

echo "ç£ç›˜:"
df -h | grep -E '(cloud_storage|/$)'

echo "CPUæ¸©åº¦:"
vcgencmd measure_temp

echo ""
echo "=== æ´»åŠ¨è¿æ¥ ==="
ss -tunlp | grep -E '(8000|80|443)' | wc -l
```

è®¾ç½®å¯æ‰§è¡Œï¼š

```bash
chmod +x /opt/raspberrycloud/scripts/monitor.sh
```

è¿è¡Œç›‘æ§ï¼š

```bash
/opt/raspberrycloud/scripts/monitor.sh
```

### 9.3 è®¾ç½®å®šæ—¶ä»»åŠ¡

```bash
crontab -e
```

æ·»åŠ ï¼š

```bash
# æ¯å°æ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
0 * * * * find /mnt/cloud_storage/temp -type f -mtime +1 -delete

# æ¯å¤©å‡Œæ™¨å¤‡ä»½æ•°æ®åº“
0 3 * * * /opt/raspberrycloud/scripts/backup.sh

# æ¯5åˆ†é’Ÿæ£€æŸ¥æœåŠ¡çŠ¶æ€
*/5 * * * * systemctl is-active raspberrycloud || systemctl restart raspberrycloud
```

## âœ… éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] Pythonè™šæ‹Ÿç¯å¢ƒå·²åˆ›å»ºå¹¶æ¿€æ´»
- [ ] æ‰€æœ‰Pythonä¾èµ–å·²å®‰è£…
- [ ] æ•°æ®åº“å·²åˆå§‹åŒ–
- [ ] åç«¯æœåŠ¡å¯ä»¥å¯åŠ¨ï¼ˆsystemctl status raspberrycloudï¼‰
- [ ] Nginxé…ç½®æ­£ç¡®ï¼ˆnginx -tï¼‰
- [ ] Webç•Œé¢å¯è®¿é—®ï¼ˆhttp://æ ‘è“æ´¾IPï¼‰
- [ ] å¯ä»¥ç™»å½•é»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
- [ ] æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½åŠŸèƒ½æ­£å¸¸
- [ ] Sambaå…±äº«å¯è®¿é—®
- [ ] æœåŠ¡å·²è®¾ç½®å¼€æœºè‡ªå¯
- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡º

## ğŸ‰ ä¸‹ä¸€æ­¥

ç³»ç»Ÿéƒ¨ç½²å®Œæˆï¼æ¥ä¸‹æ¥ï¼š
1. [é…ç½®å¤šç«¯è®¿é—®](03-å¤šç«¯è®¿é—®é…ç½®.md) - è®¾ç½®å¤–ç½‘è®¿é—®ã€HTTPSã€ç§»åŠ¨ç«¯
2. [å®‰å…¨åŠ å›º](04-å®‰å…¨åŠ å›ºæŒ‡å—.md) - å¢å¼ºç³»ç»Ÿå®‰å…¨æ€§
3. ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç ï¼

## ğŸ”§ æ•…éšœæ’é™¤

### åç«¯æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u raspberrycloud -n 50 --no-pager

# å¸¸è§é—®é¢˜ï¼š
# 1. ç«¯å£è¢«å ç”¨
sudo lsof -i :8000
# æ€æ­»è¿›ç¨‹ï¼šsudo kill -9 PID

# 2. Pythonä¾èµ–ç¼ºå¤±
source /opt/raspberrycloud/venv/bin/activate
pip install -r /opt/raspberrycloud/backend/requirements.txt

# 3. æ•°æ®åº“è¿æ¥å¤±è´¥
# æ£€æŸ¥.envé…ç½®çš„DATABASE_URLæ˜¯å¦æ­£ç¡®
```

### Nginx 502é”™è¯¯

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
sudo systemctl status raspberrycloud

# æ£€æŸ¥ç«¯å£
curl http://localhost:8000/api/health

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/raspberrycloud_error.log
```

### æ–‡ä»¶ä¸Šä¼ å¤±è´¥

```bash
# æ£€æŸ¥å­˜å‚¨ç›®å½•æƒé™
ls -la /mnt/cloud_storage/

# ä¿®å¤æƒé™
sudo chown -R www-data:www-data /mnt/cloud_storage
sudo chmod -R 755 /mnt/cloud_storage

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /mnt/cloud_storage
```


