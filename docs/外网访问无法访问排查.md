# å¤–ç½‘æ— æ³•è®¿é—®æ’æŸ¥æŒ‡å—

## ğŸ” é—®é¢˜è¯Šæ–­

å¤–ç½‘æ— æ³•è®¿é—®é€šå¸¸ç”±ä»¥ä¸‹åŸå› å¯¼è‡´ï¼š
1. **ç«¯å£è½¬å‘æœªé…ç½®**
2. **é˜²ç«å¢™é˜»æ­¢**
3. **DNSæœªå®Œå…¨ä¼ æ’­**
4. **è¿è¥å•†å°ç¦ç«¯å£**

## ğŸ“‹ å®Œæ•´æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æ ‘è“æ´¾æœ¬åœ°æœåŠ¡

```bash
# åœ¨æ ‘è“æ´¾ä¸Šæ£€æŸ¥Nginxæ˜¯å¦è¿è¡Œ
sudo systemctl status nginx

# æ£€æŸ¥æœ¬åœ°æ˜¯å¦å¯ä»¥è®¿é—®
curl -I http://localhost

# åº”è¯¥è¿”å›HTTPå“åº”ï¼ˆ200æˆ–301ï¼‰
```

**å¦‚æœæœ¬åœ°æ— æ³•è®¿é—®ï¼š**
```bash
# å¯åŠ¨Nginx
sudo systemctl start nginx

# æ£€æŸ¥Nginxé…ç½®
sudo nginx -t

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -20 /var/log/nginx/error.log
```

### æ­¥éª¤2ï¼šæ£€æŸ¥æ ‘è“æ´¾é˜²ç«å¢™

```bash
# æ£€æŸ¥UFWçŠ¶æ€
sudo ufw status

# å¦‚æœUFWå¯ç”¨ï¼Œç¡®ä¿å¼€æ”¾80å’Œ443ç«¯å£
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# é‡æ–°åŠ è½½
sudo ufw reload

# éªŒè¯
sudo ufw status numbered
```

### æ­¥éª¤3ï¼šæ£€æŸ¥Windowsç«¯å£è½¬å‘ï¼ˆå…³é”®ï¼ï¼‰

è¿™æ˜¯æœ€å¸¸è§çš„é—®é¢˜ï¼éœ€è¦åœ¨Windowsç¬”è®°æœ¬ä¸Šé…ç½®ç«¯å£è½¬å‘ã€‚

#### 3.1 è·å–æ ‘è“æ´¾å†…ç½‘IP

```bash
# åœ¨æ ‘è“æ´¾ä¸Šæ‰§è¡Œ
hostname -I
# æˆ–
ip addr show | grep "inet " | grep -v 127.0.0.1
```

è®°å½•æ ‘è“æ´¾çš„IPåœ°å€ï¼Œä¾‹å¦‚ï¼š`192.168.137.100`

#### 3.2 åœ¨Windowsä¸Šé…ç½®ç«¯å£è½¬å‘

**æ–¹æ³•Aï¼šä½¿ç”¨PowerShellï¼ˆæ¨èï¼‰**

1. **ä»¥ç®¡ç†å‘˜èº«ä»½æ‰“å¼€PowerShell**

2. **æŸ¥çœ‹å½“å‰ç«¯å£è½¬å‘è§„åˆ™ï¼š**
   ```powershell
   netsh interface portproxy show all
   ```

3. **æ·»åŠ ç«¯å£è½¬å‘è§„åˆ™ï¼š**
   ```powershell
   # æ›¿æ¢ 192.168.137.100 ä¸ºä½ çš„æ ‘è“æ´¾å®é™…IP
   
   # æ·»åŠ 80ç«¯å£è½¬å‘
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.137.100
   
   # æ·»åŠ 443ç«¯å£è½¬å‘
   netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=192.168.137.100
   ```

4. **éªŒè¯é…ç½®ï¼š**
   ```powershell
   netsh interface portproxy show all
   ```

5. **å¦‚æœé…ç½®é”™è¯¯ï¼Œåˆ é™¤åé‡æ–°æ·»åŠ ï¼š**
   ```powershell
   # åˆ é™¤æ‰€æœ‰ç«¯å£è½¬å‘
   netsh interface portproxy reset
   
   # é‡æ–°æ·»åŠ 
   netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.137.100
   netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=192.168.137.100
   ```

**æ–¹æ³•Bï¼šä½¿ç”¨å›¾å½¢ç•Œé¢ï¼ˆå¦‚æœPowerShellä¸å·¥ä½œï¼‰**

1. ä¸‹è½½å¹¶å®‰è£… [Simple Port Forwarding](https://simpleportforwarding.com/) æˆ–ç±»ä¼¼å·¥å…·
2. é…ç½®ç«¯å£è½¬å‘è§„åˆ™

#### 3.3 è®¾ç½®Windowsé˜²ç«å¢™è§„åˆ™

**åœ¨Windowsä¸Šï¼š**

1. æ‰“å¼€"Windows Defender é˜²ç«å¢™"
2. ç‚¹å‡»"é«˜çº§è®¾ç½®"
3. é€‰æ‹©"å…¥ç«™è§„åˆ™" â†’ "æ–°å»ºè§„åˆ™"
4. é€‰æ‹©"ç«¯å£" â†’ ä¸‹ä¸€æ­¥
5. é€‰æ‹©"TCP"ï¼Œè¾“å…¥ç«¯å£ `80` â†’ ä¸‹ä¸€æ­¥
6. é€‰æ‹©"å…è®¸è¿æ¥" â†’ ä¸‹ä¸€æ­¥
7. å…¨é€‰ï¼ˆåŸŸã€ä¸“ç”¨ã€å…¬ç”¨ï¼‰â†’ ä¸‹ä¸€æ­¥
8. è¾“å…¥åç§°ï¼š"å…è®¸HTTPç«¯å£80" â†’ å®Œæˆ

**é‡å¤ä¸Šè¿°æ­¥éª¤ä¸º443ç«¯å£åˆ›å»ºè§„åˆ™**

**æˆ–è€…ä½¿ç”¨PowerShellï¼ˆç®¡ç†å‘˜ï¼‰ï¼š**
```powershell
# å…è®¸80ç«¯å£
New-NetFirewallRule -DisplayName "Allow HTTP Port 80" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow

# å…è®¸443ç«¯å£
New-NetFirewallRule -DisplayName "Allow HTTPS Port 443" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow
```

### æ­¥éª¤4ï¼šæ£€æŸ¥ç¬”è®°æœ¬å…¬ç½‘IP

```bash
# åœ¨æ ‘è“æ´¾ä¸Šæ£€æŸ¥å½“å‰å…¬ç½‘IP
curl -s https://api.ip.sb/ip

# åœ¨Windowsç¬”è®°æœ¬æµè§ˆå™¨ä¸­è®¿é—®ï¼š
# https://ip.sb
# æˆ–
# https://www.ip138.com

# ç¡®è®¤ä¸¤ä¸ªIPæ˜¯å¦ä¸€è‡´
```

### æ­¥éª¤5ï¼šæµ‹è¯•ç«¯å£æ˜¯å¦å¼€æ”¾

**æ–¹æ³•Aï¼šä½¿ç”¨åœ¨çº¿å·¥å…·**

è®¿é—®ä»¥ä¸‹ç½‘ç«™æµ‹è¯•ç«¯å£ï¼š
- https://tool.chinaz.com/port/
- https://www.yougetsignal.com/tools/open-ports/

è¾“å…¥ä½ çš„å…¬ç½‘IPå’Œç«¯å£80ï¼Œç‚¹å‡»æµ‹è¯•ã€‚

**æ–¹æ³•Bï¼šä»å¤–ç½‘æµ‹è¯•ï¼ˆæ‰‹æœº4Gï¼‰**

```bash
# åœ¨æ‰‹æœºæµè§ˆå™¨ä¸­è®¿é—®
http://ä½ çš„å…¬ç½‘IP

# æˆ–ä½¿ç”¨åŸŸå
http://piowncloud.com
```

**æ–¹æ³•Cï¼šä½¿ç”¨telnetï¼ˆå¦‚æœæœ‰å¤–ç½‘æœåŠ¡å™¨ï¼‰**

```bash
telnet ä½ çš„å…¬ç½‘IP 80
```

### æ­¥éª¤6ï¼šæ£€æŸ¥è¿è¥å•†æ˜¯å¦å°ç¦ç«¯å£

**å¦‚æœ80/443ç«¯å£è¢«å°ç¦ï¼š**

1. **ä½¿ç”¨éæ ‡å‡†ç«¯å£ï¼ˆ8080/8443ï¼‰**

   **ä¿®æ”¹Nginxé…ç½®ï¼š**
   ```bash
   sudo nano /etc/nginx/sites-available/raspberrycloud
   ```
   
   ä¿®æ”¹ç›‘å¬ç«¯å£ï¼š
   ```nginx
   server {
       listen 8080;  # æ”¹ä¸º8080
       # ...
   }
   ```
   
   **Windowsç«¯å£è½¬å‘ï¼š**
   ```powershell
   netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=8080 connectaddress=192.168.137.100
   ```
   
   **æ³¨æ„ï¼š** Let's Encryptéœ€è¦80ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ï¼š
   - ä¸´æ—¶æ˜ å°„80ç«¯å£ç”³è¯·è¯ä¹¦
   - æˆ–ä½¿ç”¨standaloneæ¨¡å¼

2. **ä¸´æ—¶ä½¿ç”¨80ç«¯å£ç”³è¯·è¯ä¹¦**

   ```bash
   # 1. ä¸´æ—¶ä¿®æ”¹Windowsç«¯å£è½¬å‘ï¼Œå°†80æ˜ å°„åˆ°æ ‘è“æ´¾
   # 2. ç”³è¯·è¯ä¹¦
   sudo certbot --nginx -d piowncloud.com -d www.piowncloud.com
   # 3. ç”³è¯·å®Œæˆåï¼Œæ”¹å›8080ç«¯å£
   ```

### æ­¥éª¤7ï¼šéªŒè¯DNSè§£æ

```bash
# åœ¨æ ‘è“æ´¾ä¸Š
nslookup piowncloud.com

# åº”è¯¥è¿”å›ä½ çš„å…¬ç½‘IP
# å¦‚æœè¿”å›å…¶ä»–IPæˆ–æ— æ³•è§£æï¼Œç­‰å¾…DNSä¼ æ’­ï¼ˆæœ€å¤š48å°æ—¶ï¼‰
```

## ğŸ”§ å¿«é€Ÿä¿®å¤è„šæœ¬

### Windowsç«¯å£è½¬å‘ä¸€é”®é…ç½®è„šæœ¬

åœ¨Windows PowerShellï¼ˆç®¡ç†å‘˜ï¼‰ä¸­æ‰§è¡Œï¼š

```powershell
# è·å–æ ‘è“æ´¾IPï¼ˆéœ€è¦å…ˆåœ¨æ ‘è“æ´¾ä¸Šæ‰§è¡Œ hostname -I è·å–ï¼‰
$RASPBERRY_IP = Read-Host "è¯·è¾“å…¥æ ‘è“æ´¾å†…ç½‘IPï¼ˆä¾‹å¦‚: 192.168.137.100ï¼‰"

# åˆ é™¤ç°æœ‰è§„åˆ™ï¼ˆå¦‚æœæœ‰ï¼‰
netsh interface portproxy reset

# æ·»åŠ ç«¯å£è½¬å‘
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=$RASPBERRY_IP
netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=$RASPBERRY_IP

# æ·»åŠ é˜²ç«å¢™è§„åˆ™
New-NetFirewallRule -DisplayName "Allow HTTP Port 80" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow -ErrorAction SilentlyContinue
New-NetFirewallRule -DisplayName "Allow HTTPS Port 443" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow -ErrorAction SilentlyContinue

# æ˜¾ç¤ºé…ç½®
Write-Host "`nç«¯å£è½¬å‘é…ç½®å®Œæˆï¼" -ForegroundColor Green
netsh interface portproxy show all
```

### æ ‘è“æ´¾é˜²ç«å¢™ä¸€é”®é…ç½®è„šæœ¬

åœ¨æ ‘è“æ´¾ä¸Šæ‰§è¡Œï¼š

```bash
#!/bin/bash
# è®¾ç½®æ‰§è¡Œæƒé™: chmod +x fix_firewall.sh

echo "é…ç½®é˜²ç«å¢™è§„åˆ™..."

# å¼€æ”¾80å’Œ443ç«¯å£
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# é‡æ–°åŠ è½½
sudo ufw reload

# æ˜¾ç¤ºçŠ¶æ€
echo ""
echo "é˜²ç«å¢™çŠ¶æ€ï¼š"
sudo ufw status numbered
```

## ğŸ“ æ£€æŸ¥æ¸…å•

åœ¨é‡æ–°æµ‹è¯•å¤–ç½‘è®¿é—®å‰ï¼Œç¡®è®¤ï¼š

- [ ] æ ‘è“æ´¾NginxæœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] æ ‘è“æ´¾æœ¬åœ°å¯ä»¥è®¿é—®ï¼ˆcurl http://localhostï¼‰
- [ ] æ ‘è“æ´¾é˜²ç«å¢™å·²å¼€æ”¾80å’Œ443ç«¯å£
- [ ] Windowsç«¯å£è½¬å‘å·²é…ç½®ï¼ˆ80å’Œ443ï¼‰
- [ ] Windowsé˜²ç«å¢™å·²å…è®¸80å’Œ443ç«¯å£
- [ ] DNSè§£ææ­£ç¡®ï¼ˆnslookup piowncloud.comï¼‰
- [ ] ç¬”è®°æœ¬å…¬ç½‘IPæ­£ç¡®

## ğŸ¯ æµ‹è¯•æ­¥éª¤

1. **ä»æ ‘è“æ´¾æœ¬åœ°æµ‹è¯•ï¼š**
   ```bash
   curl -I http://localhost
   ```

2. **ä»Windowsç¬”è®°æœ¬æµ‹è¯•ï¼š**
   ```bash
   # åœ¨PowerShellä¸­
   curl -I http://æ ‘è“æ´¾å†…ç½‘IP
   # ä¾‹å¦‚: curl -I http://192.168.137.100
   ```

3. **ä»å¤–ç½‘æµ‹è¯•ï¼ˆæ‰‹æœº4Gï¼‰ï¼š**
   - è®¿é—®ï¼š`http://ä½ çš„å…¬ç½‘IP`
   - æˆ–ï¼š`http://piowncloud.com`

4. **å¦‚æœå¤–ç½‘å¯ä»¥è®¿é—®ï¼Œå†ç”³è¯·SSLè¯ä¹¦ï¼š**
   ```bash
   sudo certbot --nginx -d piowncloud.com -d www.piowncloud.com
   ```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç«¯å£è½¬å‘é…ç½®åä»ç„¶æ— æ³•è®¿é—®

**å¯èƒ½åŸå› ï¼š**
- Windowsé˜²ç«å¢™é˜»æ­¢
- è¿è¥å•†å°ç¦ç«¯å£
- DNSæœªå®Œå…¨ä¼ æ’­

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥Windowsé˜²ç«å¢™è§„åˆ™
2. ä½¿ç”¨åœ¨çº¿å·¥å…·æµ‹è¯•ç«¯å£æ˜¯å¦å¼€æ”¾
3. ç­‰å¾…DNSä¼ æ’­ï¼ˆæœ€å¤š48å°æ—¶ï¼‰

### Q2: ä½¿ç”¨æ‰‹æœº4Gå¯ä»¥è®¿é—®ï¼Œä½†è¯ä¹¦ç”³è¯·ä»ç„¶å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- Let's EncryptæœåŠ¡å™¨æ— æ³•è®¿é—®ä½ çš„åŸŸå
- DNSä¼ æ’­ä¸å®Œæ•´

**è§£å†³æ–¹æ³•ï¼š**
1. ä½¿ç”¨åœ¨çº¿å·¥å…·æµ‹è¯•ï¼šhttps://tool.chinaz.com/port/
2. ç¡®è®¤80ç«¯å£å¯ä»¥ä»å¤–ç½‘è®¿é—®
3. ç­‰å¾…DNSå®Œå…¨ä¼ æ’­åå†ç”³è¯·

### Q3: è¿è¥å•†å°ç¦80/443ç«¯å£

**è§£å†³æ–¹æ³•ï¼š**
1. ä½¿ç”¨éæ ‡å‡†ç«¯å£ï¼ˆ8080/8443ï¼‰æä¾›æ­£å¸¸æœåŠ¡
2. ä¸´æ—¶æ˜ å°„80ç«¯å£ç”³è¯·è¯ä¹¦
3. æˆ–ä½¿ç”¨standaloneæ¨¡å¼ç”³è¯·è¯ä¹¦

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆä»¥ä¸Šé…ç½®åï¼š
1. ä»å¤–ç½‘ï¼ˆæ‰‹æœº4Gï¼‰æµ‹è¯•è®¿é—®
2. ç¡®è®¤å¯ä»¥è®¿é—®åï¼Œç”³è¯·SSLè¯ä¹¦
3. é…ç½®HTTPSè‡ªåŠ¨é‡å®šå‘

