# 笔记本网络环境域名配置完整指南

适用于树莓派通过笔记本连接网络，使用阿里云域名的完整配置流程。

## 📋 前置条件

- ✅ 已购买阿里云域名
- ✅ 树莓派已通过笔记本连接网络（WiFi热点或同一局域网）
- ✅ 树莓派上已部署RaspberryCloud服务
- ✅ 笔记本可以正常上网

## 🔍 第一步：判断网络环境

首先需要判断你的网络环境，选择对应的配置方案。

### 检查笔记本是否有公网IP

在笔记本上打开浏览器，访问以下任一网站查看IP：
- https://ip.sb
- https://www.ip138.com
- https://ifconfig.me

**判断标准：**
- 如果显示的IP是 `10.x.x.x`、`172.16-31.x.x` 或 `192.168.x.x` → **内网IP**，使用方案二（内网穿透）
- 如果显示的IP是其他格式（如 `123.45.67.89`）→ **可能是公网IP**，先尝试方案一（端口转发）

---

## 🚀 方案一：有公网IP（推荐）

如果你的笔记本有公网IP，可以通过路由器端口转发实现外网访问。

### 步骤1：获取树莓派内网IP

在树莓派上执行：

```bash
hostname -I
# 或
ip addr show | grep "inet " | grep -v 127.0.0.1
```

记录树莓派的IP地址，例如：`192.168.137.100`

### 步骤2：配置笔记本端口转发

#### 2.1 Windows笔记本配置端口转发

**方法A：使用Windows自带的端口转发（推荐）**

1. **以管理员身份打开PowerShell**

2. **查看网络连接信息**
```powershell
# 查看网络适配器
Get-NetAdapter
# 记录连接树莓派的适配器名称，例如：以太网、WLAN等
```

3. **配置端口转发规则**
```powershell
# 添加80端口转发（HTTP）
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=树莓派IP

# 添加443端口转发（HTTPS）
netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=树莓派IP

# 示例（树莓派IP为192.168.137.100）：
netsh interface portproxy add v4tov4 listenport=80 listenaddress=0.0.0.0 connectport=80 connectaddress=192.168.137.51
netsh interface portproxy add v4tov4 listenport=443 listenaddress=0.0.0.0 connectport=443 connectaddress=192.168.137.51
```

4. **配置Windows防火墙**
```powershell
# 允许80端口入站
New-NetFirewallRule -DisplayName "RaspberryCloud HTTP" -Direction Inbound -LocalPort 80 -Protocol TCP -Action Allow

# 允许443端口入站
New-NetFirewallRule -DisplayName "RaspberryCloud HTTPS" -Direction Inbound -LocalPort 443 -Protocol TCP -Action Allow
```

5. **验证端口转发**
```powershell
# 查看所有端口转发规则
netsh interface portproxy show all
```

**方法B：使用第三方工具（如NATAPP、ngrok）**

如果Windows端口转发配置复杂，可以使用内网穿透工具（见方案二）。

#### 2.2 如果笔记本连接了路由器

如果你的笔记本通过路由器连接网络，需要在路由器中配置端口转发：

1. **登录路由器管理界面**
   - 通常访问：`192.168.1.1` 或 `192.168.0.1`
   - 输入管理员账号密码

2. **找到端口转发/虚拟服务器设置**
   - TP-Link: 应用管理 → 虚拟服务器
   - 华为: 安全设置 → 虚拟服务器
   - 小米: 高级设置 → 端口转发
   - 华硕: 高级设置 → 端口转发

3. **添加端口转发规则**

| 规则名称 | 外部端口 | 内部IP | 内部端口 | 协议 |
|---------|---------|--------|---------|------|
| HTTP | 80 | 树莓派IP | 80 | TCP |
| HTTPS | 443 | 树莓派IP | 443 | TCP |

**注意：** 如果运营商封禁80/443端口，使用其他端口（如8080/8443）

### 步骤3：获取笔记本公网IP

在笔记本上执行：

```bash
# Windows PowerShell
Invoke-WebRequest -Uri "https://ip.sb" -UseBasicParsing | Select-Object -ExpandProperty Content

# 或访问网站查看
# https://ip.sb
# https://www.ip138.com
```

记录公网IP地址，例如：`123.45.67.89`

### 步骤4：配置阿里云域名解析

#### 4.1 登录阿里云控制台

1. 访问阿里云控制台：https://dns.console.aliyun.com
2. 或：登录阿里云 → 控制台 → 产品与服务 → 域名 → 域名解析DNS

#### 4.2 判断IP类型

**重要：** 如果你的笔记本使用了VPN/梯子，公网IP会经常变化，需要使用**动态DNS（DDNS）**方案。

**判断方法：**
- ✅ **固定IP**：每次查看IP都相同 → 使用静态A记录（见4.3）
- ⚠️ **动态IP**：每次查看IP都不同（如使用VPN） → 使用DDNS自动更新（见4.4）

#### 4.3 添加A记录（固定IP，静态配置）

如果你的公网IP是固定的，可以手动配置：

1. 在域名列表中，找到你的域名
2. 点击"解析设置"或"解析"按钮
3. 点击"添加记录"按钮

**填写信息：**
- **记录类型**：选择 `A`
- **主机记录**：输入 `@`（表示主域名）
- **记录值**：输入你的公网IP（如：`123.45.67.89`）
- **TTL**：输入 `600`（10分钟，或使用默认值）
- **解析线路**：选择"默认"（或根据需求选择）

4. 点击"确认"保存

**添加www子域名：**

重复上述步骤，添加第二条记录：
- **主机记录**：输入 `www`
- **记录值**：输入你的公网IP（与主域名相同）
- 其他配置相同

#### 4.4 配置动态DNS（动态IP，推荐VPN用户）⭐

如果你的公网IP会变化（使用VPN/梯子），需要配置自动更新：

##### 步骤1：创建RAM子账号（推荐，更安全）⭐

**⚠️ 安全提示：** 强烈建议使用RAM子账号，而不是主账号AccessKey！

**为什么使用RAM子账号？**
- ✅ **最小权限原则**：只授予DNS管理权限，即使泄露也只能操作DNS
- ✅ **安全隔离**：不影响主账号和其他服务
- ✅ **易于管理**：可以随时禁用，不影响主账号使用

**步骤：**

1. **登录RAM控制台**
   - 访问：https://ram.console.aliyun.com
   - 或：控制台 → 产品与服务 → 访问控制（RAM）

2. **创建RAM用户**
   - 点击左侧"用户" → "创建用户"
   - **登录名称**：输入 `ddns-user`（或自定义）
   - **显示名称**：输入 `DDNS更新用户`（或自定义）
   - **访问方式**：勾选"编程访问"（会生成AccessKey）
   - 点击"确定"

3. **保存AccessKey信息**
   - 创建成功后，会显示AccessKey ID和Secret
   - **立即保存**（只显示一次！）
   - AccessKey ID：`LTAI5t...`
   - AccessKey Secret：`xxxx...`

4. **授予DNS管理权限**
   - 在用户列表中，找到刚创建的用户
   - 点击"添加权限"
   - 选择"AliyunDNSFullAccess"（DNS完全管理权限）
   - 或选择"AliyunDNSReadOnlyAccess"（只读）+ 自定义策略（仅允许更新DNS记录）
   - 点击"确定"

5. **验证权限**
   - 确保用户已拥有DNS管理权限
   - 可以测试使用该AccessKey调用DNS API

**替代方案：使用主账号AccessKey（不推荐）**

如果不想创建RAM子账号，也可以使用主账号AccessKey：

1. **登录阿里云控制台**
   - 访问：https://ram.console.aliyun.com/manage/ak
   - 或：控制台 → 右上角头像 → AccessKey管理

2. **创建AccessKey**
   - 点击"创建AccessKey"
   - 按提示完成身份验证（手机验证码）
   - **立即保存** AccessKey ID 和 AccessKey Secret（只显示一次！）

3. **记录信息**
   - AccessKey ID：`LTAI5t...`
   - AccessKey Secret：`xxxx...`

**⚠️ 安全警告：**
- 主账号AccessKey拥有账户的完全权限
- 如果泄露，可能导致整个账户被控制
- 建议定期轮换AccessKey
- 不要将AccessKey提交到代码仓库

##### 步骤2：首次添加DNS记录（手动）

即使使用DDNS，也需要先手动添加一条A记录：

1. 在阿里云DNS控制台添加A记录
2. **主机记录**：`@` 或 `www`
3. **记录值**：可以暂时填写任意IP（如：`1.1.1.1`），脚本会自动更新
4. **TTL**：`600`（10分钟）
5. 点击"确认"保存

##### 步骤3：配置自动更新脚本

**方法一：使用配置向导（推荐）⭐**

```bash
# 1. 进入项目目录
cd ~/Desktop/Github/RaspiOwnCloud
# 或
cd /opt/raspberrycloud

# 2. 运行配置向导
bash scripts/setup_aliyun_dns_config.sh
```

配置向导会引导您逐步输入：
- AccessKey ID
- AccessKey Secret
- 域名
- 子域名

**方法二：手动编辑配置文件**

```bash
# 1. 进入项目目录
cd ~/Desktop/Github/RaspiOwnCloud
# 或
cd /opt/raspberrycloud

# 2. 编辑更新脚本
nano scripts/update_aliyun_dns.sh
```

**修改配置信息：**

```bash
# 找到以下行并修改为你的实际值
export ALIYUN_ACCESS_KEY_ID="你的AccessKey ID"        # ⚠️ 必须修改！
export ALIYUN_ACCESS_KEY_SECRET="你的AccessKey Secret"  # ⚠️ 必须修改！
export ALIYUN_DOMAIN="你的域名.com"  # ⚠️ 必须修改！例如: piowncloud.com
export ALIYUN_SUBDOMAIN="@"  # @ 表示主域名，www 表示www子域名
```

**⚠️ 重要：必须将示例值替换为实际值！**

**示例（正确配置）：**
```bash
export ALIYUN_ACCESS_KEY_ID="LTAI5tAbCdEfGhIjKlMnOpQr"
export ALIYUN_ACCESS_KEY_SECRET="xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
export ALIYUN_DOMAIN="piowncloud.com"
export ALIYUN_SUBDOMAIN="@"
```

**检查配置是否正确：**
```bash
# 运行配置检查脚本
bash scripts/check_aliyun_config.sh
```

**保存并设置执行权限：**

```bash
chmod +x scripts/update_aliyun_dns.sh
chmod +x scripts/update_aliyun_dns.py
```

##### 步骤4：检查配置

**在测试之前，先检查配置是否正确：**

```bash
# 运行配置检查脚本
bash scripts/check_aliyun_config.sh
```

**如果显示错误，说明配置文件中还有示例值，需要修改。**

##### 步骤5：测试脚本

```bash
# 手动运行一次，测试是否正常
bash scripts/update_aliyun_dns.sh
```

**预期输出：**
```
[2024-12-08 12:00:00] 正在获取当前公网IP...
[INFO] 当前公网IP: 123.45.67.89
[INFO] 正在查询DNS记录: @.example.com
[INFO] DNS记录当前IP: 1.1.1.1
[INFO] IP已变化，正在更新DNS记录...
[SUCCESS] DNS记录已更新: example.com -> 123.45.67.89
```

**如果遇到问题，请查看下方"故障排查"部分。**

##### 步骤6：设置定时任务（自动更新）

```bash
# 编辑crontab
crontab -e
```

**在crontab文件中添加以下行（添加到文件末尾即可）：**

**选项1：每5分钟检查一次（推荐）**

```bash
# 阿里云DNS自动更新（每5分钟）
*/5 * * * * /opt/raspberrycloud/scripts/update_aliyun_dns.sh >/dev/null 2>&1
```

**选项2：每10分钟检查一次（更节省API调用）**

```bash
# 阿里云DNS自动更新（每10分钟）
*/10 * * * * /opt/raspberrycloud/scripts/update_aliyun_dns.sh >/dev/null 2>&1
```

**选项3：更频繁（每2分钟，适合IP变化频繁的场景）**

```bash
# 阿里云DNS自动更新（每2分钟）
*/2 * * * * /opt/raspberrycloud/scripts/update_aliyun_dns.sh >/dev/null 2>&1
```

**说明：**
- 如果项目部署在其他路径，请修改为实际路径
- `>/dev/null 2>&1` 表示不输出日志（静默运行）
- 如果需要查看日志，可以改为：`>> /var/log/aliyun_dns_update.log 2>&1`

**保存并退出**（nano: Ctrl+O, Enter, Ctrl+X）

**验证定时任务：**

```bash
# 查看已添加的定时任务
crontab -l

# 应该能看到刚才添加的行
```

##### 步骤7：验证自动更新

```bash
# 查看cron日志（如果启用）
grep CRON /var/log/syslog | tail -5

# 查看脚本日志（如果有）
tail -f /var/log/aliyun_dns_update.log

# 手动检查DNS记录
nslookup 你的域名.com
```

**预期结果：**
- DNS记录应该显示你当前的实际公网IP
- 当IP变化时，DNS记录会在5分钟内自动更新

##### 步骤8：配置多个子域名（可选）

如果需要同时更新 `@` 和 `www` 两个记录，可以：

**方法1：创建两个定时任务**

```bash
crontab -e
```

添加两行：

```bash
# 更新主域名
*/5 * * * * ALIYUN_SUBDOMAIN="@" /opt/raspberrycloud/scripts/update_aliyun_dns.sh >/dev/null 2>&1

# 更新www子域名
*/5 * * * * ALIYUN_SUBDOMAIN="www" /opt/raspberrycloud/scripts/update_aliyun_dns.sh >/dev/null 2>&1
```

**方法2：修改脚本支持多个域名**

可以修改脚本，在配置中指定多个子域名，脚本会自动更新所有记录。

#### 4.4 验证DNS解析

**等待DNS生效：**
- 通常5-30分钟生效
- 最长可能需要48小时（但一般很快）

**验证方法：**

在笔记本或树莓派上执行：

```bash
# Windows PowerShell
nslookup 你的域名.com

# Linux/树莓派
nslookup 你的域名.com
# 或
dig 你的域名.com
```

**预期结果：**
- 应该返回你配置的公网IP地址
- 如果返回的不是你的公网IP，说明DNS还未生效，请等待

**在线验证工具：**
- https://dnschecker.org
- https://www.whatsmydns.net

### 步骤5：配置树莓派Nginx

在树莓派上执行：

```bash
# 编辑Nginx配置
sudo nano /etc/nginx/sites-available/raspberrycloud
```

**找到以下行：**
```nginx
server_name _;  # 替换为你的域名，如: cloud.example.com
```

**修改为：**
```nginx
server_name 你的域名.com www.你的域名.com;
```

**完整示例（假设域名为 mycloud.com）：**
```nginx
server_name mycloud.com www.mycloud.com;
```

**保存文件：**
- 按 `Ctrl+O` 保存
- 按 `Enter` 确认
- 按 `Ctrl+X` 退出

**测试并重载：**

```bash
# 测试Nginx配置语法
sudo nginx -t

# 如果显示 "syntax is ok" 和 "test is successful"，继续下一步
# 如果有错误，检查配置文件中的域名是否正确

# 重载Nginx配置（不中断服务）
sudo systemctl reload nginx

# 或者重启Nginx（会短暂中断服务）
sudo systemctl restart nginx
```

### 步骤6：配置HTTPS（SSL证书）

#### 6.1 安装Certbot

在树莓派上执行：

```bash
# 更新软件包列表
sudo apt update

# 安装Certbot和Nginx插件
sudo apt install -y certbot python3-certbot-nginx

# 验证安装
certbot --version
```

#### 6.2 申请SSL证书

**重要前提：**
- ✅ 域名已正确解析到你的公网IP（步骤4已完成）
- ✅ 80端口已映射并可访问（步骤2已完成）
- ✅ Nginx配置已更新（步骤5已完成）

**申请证书：**

```bash
# 替换为你的实际域名
sudo certbot --nginx -d 你的域名.com -d www.你的域名.com
```

**交互式操作说明：**

1. **输入邮箱地址**
   ```
   Enter email address (used for urgent renewal and security notices)
   ```
   - 输入你的邮箱（用于证书到期提醒）
   - 按回车确认

2. **同意服务条款**
   ```
   (A)gree/(C)ancel: A
   ```
   - 输入 `A` 并回车

3. **是否接收邮件通知**
   ```
   (Y)es/(N)o: N
   ```
   - 输入 `N` 并回车（推荐）

4. **选择重定向选项**
   ```
   Please choose whether or not to redirect HTTP traffic to HTTPS, removing HTTP access.
   1: No redirect - Make no further changes to the webserver configuration.
   2: Redirect - Make all requests redirect to secure HTTPS access.
   Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 2
   ```
   - 输入 `2` 并回车（推荐：自动将HTTP重定向到HTTPS）

**申请成功后：**
- Certbot会自动修改Nginx配置
- 证书文件保存在 `/etc/letsencrypt/live/你的域名.com/`
- Nginx会自动重载配置

#### 6.3 验证证书

```bash
# 查看证书信息
sudo certbot certificates

# 测试证书续期（不会真正续期）
sudo certbot renew --dry-run
```

#### 6.4 设置自动续期

Let's Encrypt证书有效期90天，需要定期续期。设置自动续期：

```bash
# 编辑crontab
sudo crontab -e
```

**如果首次使用，选择编辑器（推荐选择nano）：**
- 输入 `1` 选择 nano

**在文件末尾添加以下行：**
```cron
0 3 1 * * certbot renew --quiet && systemctl reload nginx
```

**说明：**
- `0 3 1 * *`：每月1日凌晨3点执行
- `certbot renew --quiet`：静默续期（只在需要时续期）
- `&& systemctl reload nginx`：续期成功后重载Nginx

**保存并退出：**
- 按 `Ctrl+O` 保存
- 按 `Enter` 确认
- 按 `Ctrl+X` 退出

**验证crontab：**
```bash
# 查看crontab内容
sudo crontab -l
```

### 步骤7：配置树莓派防火墙

```bash
# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 如果使用非标准端口
sudo ufw allow 8080/tcp
sudo ufw allow 8443/tcp
```

### 步骤8：验证访问

1. **验证DNS解析**
```bash
# 在树莓派或笔记本上执行
nslookup 你的域名.com
# 应该返回你的公网IP
```

2. **测试访问**
   - 使用手机4G/5G网络（关闭WiFi）
   - 浏览器访问：`https://你的域名.com`
   - 检查地址栏是否有锁图标 🔒

---

## 🌐 方案二：无公网IP（内网穿透）

如果你的笔记本没有公网IP（校园网、公司网络等），需要使用内网穿透。推荐使用 **Cloudflare Tunnel**（完全免费）。

### 步骤1：准备Cloudflare账号

1. **注册Cloudflare账号**
   - 访问：https://www.cloudflare.com
   - 注册账号（免费）

2. **添加域名到Cloudflare**
   - 登录后，点击"添加站点"
   - 输入你的阿里云域名（如：mycloud.com）
   - 选择免费计划

3. **修改DNS服务器**
   - Cloudflare会提供DNS服务器地址（如：`xxx.ns.cloudflare.com`）
   - 在阿里云域名控制台修改DNS服务器：
     - 登录阿里云 → 域名控制台
     - 找到你的域名 → 点击"管理"
     - 修改DNS服务器为Cloudflare提供的地址
   - 等待生效（通常几分钟到几小时）

### 步骤2：在树莓派上配置Cloudflare Tunnel

#### 2.1 安装 cloudflared

在树莓派上执行：

```bash
# 下载 cloudflared（ARM64版本，适用于树莓派）
cd /tmp
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64

# 添加执行权限
chmod +x cloudflared-linux-arm64

# 移动到系统路径
sudo mv cloudflared-linux-arm64 /usr/local/bin/cloudflared

# 验证安装
cloudflared --version
```

#### 2.2 登录 Cloudflare

```bash
# 执行登录命令，会打开浏览器
cloudflared tunnel login
```

**操作步骤：**
1. 命令执行后会显示一个URL
2. 在浏览器中打开该URL（如果树莓派有图形界面，会自动打开）
3. 如果没有图形界面，在笔记本浏览器中手动打开URL
4. 登录你的Cloudflare账号
5. 选择要使用的域名
6. 点击"授权"
7. 授权成功后，证书文件会保存在 `/root/.cloudflared/` 目录

#### 2.3 创建隧道

```bash
# 创建名为 raspberrycloud 的隧道
cloudflared tunnel create raspberrycloud
```

**说明：**
- 隧道名称可以自定义，这里使用 `raspberrycloud`
- 创建成功后会显示隧道ID（UUID），请记录下来

#### 2.4 查看隧道信息

```bash
# 查看所有隧道
cloudflared tunnel list

# 记录下 raspberrycloud 对应的隧道ID（UUID）
# 例如：a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

#### 2.5 配置DNS路由

将域名指向隧道：

```bash
# 配置主域名路由（替换为你的域名）
cloudflared tunnel route dns raspberrycloud 你的域名.com

# 配置www子域名路由
cloudflared tunnel route dns raspberrycloud www.你的域名.com
```

**说明：**
- 这会自动在Cloudflare中创建CNAME记录
- 将 `你的域名.com` 和 `www.你的域名.com` 指向隧道

#### 2.6 创建配置文件

首先获取隧道UUID：

```bash
# 查看隧道列表，找到 raspberrycloud 的UUID
cloudflared tunnel list
# 输出示例：
# ID                                   NAME             CREATED
# a1b2c3d4-e5f6-7890-abcd-ef1234567890 raspberrycloud   2024-01-01T12:00:00Z
```

创建配置目录和文件：

```bash
# 创建配置目录
sudo mkdir -p /etc/cloudflared

# 编辑配置文件
sudo nano /etc/cloudflared/config.yml
```

在配置文件中输入以下内容（**替换为你的实际值**）：

```yaml
tunnel: a1b2c3d4-e5f6-7890-abcd-ef1234567890  # 替换为你的隧道UUID
credentials-file: /root/.cloudflared/a1b2c3d4-e5f6-7890-abcd-ef1234567890.json  # 替换为你的证书文件路径

ingress:
  - hostname: 你的域名.com  # 替换为你的域名
    service: http://localhost:80
  - hostname: www.你的域名.com  # 替换为你的域名
    service: http://localhost:80
  - service: http_status:404
```

**重要说明：**
- `tunnel`: 替换为步骤2.4中获取的隧道UUID
- `credentials-file`: 证书文件路径通常是 `/root/.cloudflared/隧道UUID.json`
- `hostname`: 替换为你的实际域名（如：`mycloud.com`）

保存文件（Ctrl+O，回车，Ctrl+X）

#### 2.7 创建系统服务

创建systemd服务文件，让隧道开机自启：

```bash
sudo nano /etc/systemd/system/cloudflared.service
```

输入以下内容：

```ini
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel --config /etc/cloudflared/config.yml run
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

保存文件。

#### 2.8 启动服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 设置开机自启
sudo systemctl enable cloudflared

# 启动服务
sudo systemctl start cloudflared

# 检查服务状态
sudo systemctl status cloudflared
```

**验证服务运行：**
- 如果看到 `active (running)` 表示服务正常运行
- 如果看到错误，查看日志：`sudo journalctl -u cloudflared -n 50`

#### 2.9 查看服务日志（可选）

```bash
# 实时查看日志
sudo journalctl -u cloudflared -f

# 查看最近50条日志
sudo journalctl -u cloudflared -n 50
```

### 步骤3：配置树莓派Nginx

在树莓派上执行：

```bash
# 编辑Nginx配置
sudo nano /etc/nginx/sites-available/raspberrycloud
```

**找到以下行：**
```nginx
server_name _;  # 替换为你的域名，如: cloud.example.com
```

**修改为：**
```nginx
server_name 你的域名.com www.你的域名.com;
```

**完整示例（假设域名为 mycloud.com）：**
```nginx
server_name mycloud.com www.mycloud.com;
```

**保存文件：**
- 按 `Ctrl+O` 保存
- 按 `Enter` 确认
- 按 `Ctrl+X` 退出

**测试并重载：**

```bash
# 测试Nginx配置语法
sudo nginx -t

# 如果显示 "syntax is ok" 和 "test is successful"，继续下一步
# 如果有错误，检查配置文件中的域名是否正确

# 重载Nginx配置
sudo systemctl reload nginx
```

### 步骤4：验证访问

1. **等待DNS生效**（5-30分钟）

2. **从任何地方访问**
   - 浏览器访问：`https://你的域名.com`
   - 检查地址栏是否有锁图标 🔒
   - Cloudflare Tunnel 自动提供HTTPS，无需配置SSL证书

---

## ✅ 配置检查清单

### 方案一（有公网IP）

- [ ] 笔记本端口转发已配置（Windows或路由器）
- [ ] 笔记本防火墙已开放80/443端口
- [ ] 阿里云域名解析已配置（A记录）
- [ ] DNS解析已生效（nslookup验证）
- [ ] 树莓派Nginx配置已更新（server_name）
- [ ] SSL证书已申请
- [ ] 树莓派防火墙已开放端口
- [ ] 外网访问测试成功（手机4G）

### 方案二（无公网IP）

- [ ] Cloudflare账号已注册
- [ ] 域名已添加到Cloudflare
- [ ] DNS服务器已修改为Cloudflare
- [ ] Cloudflare Tunnel已配置
- [ ] 隧道服务已启动
- [ ] 树莓派Nginx配置已更新
- [ ] 外网访问测试成功

---

## 🐛 常见问题

### Q1: 获取公网IP失败，返回HTML页面

**错误现象：**
```
[INFO] 当前公网IP: <!DOCTYPE html>...
```

**原因：** IP查询服务返回了HTML页面而不是纯IP地址。

**解决方法：**

脚本已更新，会自动尝试多个IP查询服务。如果仍然失败：

1. **检查网络连接：**
```bash
# 测试网络连接
ping -c 4 8.8.8.8

# 测试DNS解析
nslookup api.ip.sb
```

2. **手动测试IP查询服务：**
```bash
# 测试不同的IP查询服务
curl https://api.ip.sb/ip
curl https://ifconfig.me/ip
curl https://api.ipify.org?format=text
curl https://ipinfo.io/ip
```

3. **如果所有服务都失败，可能是网络问题：**
   - 检查防火墙设置
   - 检查代理设置
   - 尝试使用VPN或更换网络

### Q2: AccessKey无效 - InvalidAccessKeyId

**错误现象：**
```
[ERROR] API调用失败: HTTP 404
[ERROR] 错误代码: InvalidAccessKeyId
[ERROR] 错误消息: Specified access key is not found or invalid.
```

**原因：** AccessKey ID 或 Secret 配置错误，或者配置文件中还是示例值。

**解决方法：**

1. **检查配置文件：**
```bash
# 查看配置文件
cat scripts/update_aliyun_dns.sh | grep ALIYUN_

# 如果看到"你的AccessKey"或"你的域名"，说明还没修改配置
```

2. **修改配置文件：**
```bash
# 编辑配置文件
nano scripts/update_aliyun_dns.sh

# 找到以下行并修改：
export ALIYUN_ACCESS_KEY_ID="LTAI5t..."        # 替换为你的实际AccessKey ID
export ALIYUN_ACCESS_KEY_SECRET="xxxx..."     # 替换为你的实际AccessKey Secret
export ALIYUN_DOMAIN="piowncloud.com"         # 替换为你的实际域名
export ALIYUN_SUBDOMAIN="@"                   # @ 表示主域名
```

3. **验证配置：**
```bash
# 运行配置检查脚本
bash scripts/check_aliyun_config.sh
```

4. **确认AccessKey是否正确：**
   - 登录阿里云控制台
   - 检查AccessKey ID和Secret是否正确
   - 如果是RAM子账号，确认已授予DNS管理权限
   - 如果AccessKey已过期或被删除，需要重新创建

5. **重新测试：**
```bash
bash scripts/update_aliyun_dns.sh
```

### Q3: DNS更新失败 - HTTP Error 400: Bad Request

**错误现象：**
```
[ERROR] API调用失败: HTTP Error 400: Bad Request
[ERROR] 更新DNS记录失败
```

**可能原因和解决方法：**

1. **使用测试工具诊断：**
```bash
# 运行AccessKey测试工具
bash scripts/test_aliyun_accesskey.sh
```

这个工具会：
- 检查配置是否正确
- 验证AccessKey格式
- 测试API调用
- 显示详细的错误信息

2. **检查AccessKey配置：**
```bash
# 确认环境变量已正确设置
echo $ALIYUN_ACCESS_KEY_ID
echo $ALIYUN_ACCESS_KEY_SECRET
echo $ALIYUN_DOMAIN
echo $ALIYUN_SUBDOMAIN
```

2. **检查域名格式：**
   - `ALIYUN_DOMAIN` 应该是纯域名，如：`example.com`（不要包含 `@` 或 `www`）
   - `ALIYUN_SUBDOMAIN` 应该是 `@`（主域名）或 `www`（子域名）

3. **检查DNS记录是否存在：**
   - 登录阿里云DNS控制台
   - 确认已创建对应的A记录
   - 确认记录类型是 `A`，不是 `CNAME` 或其他

4. **检查AccessKey权限：**
   - 确认AccessKey有DNS管理权限
   - 如果是RAM子账号，确认已授予 `AliyunDNSFullAccess` 权限

5. **查看详细错误信息：**
```bash
# 脚本已更新，会显示更详细的错误信息
bash scripts/update_aliyun_dns.sh
```

6. **手动测试API调用：**
```bash
# 使用Python测试API
python3 -c "
import os
os.environ['ALIYUN_ACCESS_KEY_ID'] = '你的AccessKey ID'
os.environ['ALIYUN_ACCESS_KEY_SECRET'] = '你的AccessKey Secret'
os.environ['ALIYUN_DOMAIN'] = '你的域名.com'
os.environ['ALIYUN_SUBDOMAIN'] = '@'
exec(open('scripts/update_aliyun_dns.py').read())
"
```

### Q4: DNS记录查询失败

**错误现象：**
```
[ERROR] 未找到DNS记录: @.example.com
```

**解决方法：**

1. **确认DNS记录已创建：**
   - 登录阿里云DNS控制台
   - 确认已添加A记录
   - 主机记录：`@` 或 `www`
   - 记录类型：`A`
   - 记录值：任意IP（会被脚本自动更新）

2. **检查子域名配置：**
   - 如果查询 `@`，确保主机记录是 `@`
   - 如果查询 `www`，确保主机记录是 `www`
   - 注意：`@` 在API中可能显示为空字符串

3. **检查域名配置：**
   - `ALIYUN_DOMAIN` 应该是根域名，如：`example.com`
   - 不要包含子域名，如：不要写成 `www.example.com`

## 🐛 常见问题（原内容）

### Q1: 无法从外网访问

**检查清单：**
1. ✅ 端口转发是否正确配置
2. ✅ 防火墙是否开放端口
3. ✅ 树莓派服务是否运行
4. ✅ DNS解析是否生效
5. ✅ 是否使用手机4G测试（排除本地网络缓存）

**测试命令：**
```bash
# 在树莓派上测试本地服务
curl http://localhost:8000/api/health

# 从外网测试（使用手机4G或在线工具）
curl http://你的域名.com/api/health
```

### Q2: SSL证书申请失败

**错误：** `Failed to verify domain ownership`

**可能原因：**
- 域名未正确解析到公网IP
- 80端口未开放或未映射
- 防火墙阻止

**解决方案：**
```bash
# 1. 验证域名解析
nslookup 你的域名.com

# 2. 检查80端口是否可访问
curl http://你的域名.com

# 3. 如果使用非标准端口，临时映射80端口申请证书
```

### Q3: Cloudflare Tunnel连接失败

**检查：**
```bash
# 查看服务状态
sudo systemctl status cloudflared

# 查看日志
sudo journalctl -u cloudflared -f

# 测试连接
cloudflared tunnel info
```

### Q4: Windows端口转发不生效

**可能原因：**
- 未以管理员身份运行
- 防火墙未开放端口
- IP Helper服务未启动

**解决方案：**
```powershell
# 1. 确保以管理员身份运行PowerShell

# 2. 启动IP Helper服务
Start-Service iphlpsvc
Set-Service -Name iphlpsvc -StartupType Automatic

# 3. 检查端口转发规则
netsh interface portproxy show all

# 4. 检查防火墙规则
Get-NetFirewallRule | Where-Object {$_.DisplayName -like "*RaspberryCloud*"}
```

### Q5: 笔记本IP变化（动态IP）

**解决方案：配置DDNS自动更新**

如果笔记本的公网IP会变化，需要配置DDNS：

1. **使用阿里云DNS API自动更新**
   - 需要获取AccessKey和SecretKey
   - 编写脚本定期更新A记录

2. **使用Cloudflare Tunnel（推荐）**
   - 方案二不需要公网IP，IP变化不影响

---

## 📱 访问方式

配置完成后，可以通过以下方式访问：

### 方案一（有公网IP）
- **HTTPS（推荐）**: `https://你的域名.com`
- **HTTP（自动跳转）**: `http://你的域名.com` → 自动跳转到HTTPS
- **带www**: `https://www.你的域名.com`

### 方案二（内网穿透）
- **HTTPS**: `https://你的域名.com`（Cloudflare自动提供HTTPS）
- **带www**: `https://www.你的域名.com`

---

## 🎉 完成！

现在你可以通过域名从任何地方访问你的私有云存储了！

**安全提示：**
- ✅ 立即修改默认管理员密码
- ✅ 定期更新系统和软件
- ✅ 定期检查访问日志
- ✅ 备份重要数据
- ✅ 如果使用方案一，考虑配置Fail2ban防暴力破解

---

## 📞 需要帮助？

如果遇到问题，可以：
1. 查看项目文档：`docs/` 目录
2. 检查日志：`sudo journalctl -u raspberrycloud -f`
3. 查看Nginx日志：`sudo tail -f /var/log/nginx/raspberrycloud_error.log`

