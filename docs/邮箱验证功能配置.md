# 邮箱验证功能详细配置指南

## 📋 功能说明

注册时需要通过邮箱验证码验证邮箱的有效性，提高账户安全性。系统会向用户邮箱发送6位数字验证码，用户输入正确验证码后才能完成注册。

---

## 🚀 完整配置步骤

### 第一步：找到配置文件

在树莓派上，配置文件位于：

```bash
/opt/raspberrycloud/backend/.env
```

**编辑配置文件：**

```bash
sudo nano /opt/raspberrycloud/backend/.env
```

或者使用其他编辑器：

```bash
sudo vi /opt/raspberrycloud/backend/.env
```

### 第二步：选择邮箱服务商并获取配置信息

根据您使用的邮箱服务商，选择对应的配置方案：

---

## 📧 详细配置方案

### 方案一：QQ邮箱（推荐，国内最常用）

#### 1. 获取QQ邮箱授权码

**⚠️ 重要：QQ邮箱必须使用"授权码"，不能使用登录密码！**

**详细步骤：**

1. **登录QQ邮箱**
   - 打开 https://mail.qq.com
   - 使用QQ号和密码登录

2. **进入设置页面**
   - 点击右上角"设置"
   - 选择"账户"选项卡

3. **开启SMTP服务**
   - 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
   - 找到"POP3/SMTP服务"选项
   - 点击"开启"按钮
   - 按照提示完成手机验证（发送短信验证码）

4. **生成授权码**
   - 开启服务后，点击"生成授权码"
   - 会弹出提示框，显示16位授权码（例如：`abcdefghijklmnop`）
   - **立即复制授权码**（只显示一次，关闭后无法再次查看）
   - 如果忘记，需要重新生成

5. **保存授权码**
   - 将授权码保存到安全的地方
   - 授权码格式：16位字母和数字组合

#### 2. 配置.env文件

在 `/opt/raspberrycloud/backend/.env` 文件中添加或修改以下内容：

```bash
# ==================== 邮件配置（邮箱验证）====================
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=你的QQ号@qq.com
SMTP_PASSWORD=你刚才复制的16位授权码
SMTP_FROM=你的QQ号@qq.com
```

**完整示例：**

```bash
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=123456789@qq.com
SMTP_PASSWORD=abcdefghijklmnop
SMTP_FROM=123456789@qq.com
```

**配置说明：**
- `SMTP_HOST`: QQ邮箱SMTP服务器地址（固定为 `smtp.qq.com`）
- `SMTP_PORT`: 端口号（固定为 `587`，使用TLS加密）
- `SMTP_USER`: 你的QQ邮箱地址（完整邮箱，包含@qq.com）
- `SMTP_PASSWORD`: 刚才获取的16位授权码（不是QQ密码！）
- `SMTP_FROM`: 发件人邮箱（通常与SMTP_USER相同）

---

### 方案二：163邮箱（网易邮箱）

#### 1. 获取163邮箱授权码

**详细步骤：**

1. **登录163邮箱**
   - 打开 https://mail.163.com
   - 登录你的163邮箱

2. **进入设置**
   - 点击"设置" → "POP3/SMTP/IMAP"
   - 或直接访问：https://mail.163.com/js6/main.jsp?sid=xxx&df=mail163_letter#module=settings

3. **开启SMTP服务**
   - 找到"POP3/SMTP服务"或"IMAP/SMTP服务"
   - 点击"开启"
   - 完成手机验证

4. **生成授权码**
   - 开启后，点击"生成授权码"
   - 会收到短信验证码，输入后获得授权码
   - 授权码格式：16位字符（字母+数字）

#### 2. 配置.env文件

```bash
# ==================== 邮件配置（邮箱验证）====================
SMTP_HOST=smtp.163.com
SMTP_PORT=25
SMTP_USER=你的邮箱@163.com
SMTP_PASSWORD=你获取的授权码
SMTP_FROM=你的邮箱@163.com
```

**完整示例：**

```bash
SMTP_HOST=smtp.163.com
SMTP_PORT=25
SMTP_USER=example@163.com
SMTP_PASSWORD=ABCDEFGHIJKLMNOP
SMTP_FROM=example@163.com
```

**注意：** 163邮箱端口为 `25`，不是 `587`

---

### 方案三：Gmail（Google邮箱）

#### 1. 开启两步验证并生成应用专用密码

**详细步骤：**

1. **登录Google账户**
   - 访问 https://myaccount.google.com
   - 登录你的Google账户

2. **开启两步验证**
   - 进入"安全性" → "两步验证"
   - 按照提示开启两步验证（需要手机验证）

3. **生成应用专用密码**
   - 在"安全性"页面，找到"应用专用密码"
   - 选择"邮件"和"其他（自定义名称）"
   - 输入名称（如：RaspberryCloud）
   - 点击"生成"
   - 会显示16位密码（格式：`xxxx xxxx xxxx xxxx`，去掉空格）

#### 2. 配置.env文件

```bash
# ==================== 邮件配置（邮箱验证）====================
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=你的邮箱@gmail.com
SMTP_PASSWORD=你生成的应用专用密码（16位，去掉空格）
SMTP_FROM=你的邮箱@gmail.com
```

**完整示例：**

```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=example@gmail.com
SMTP_PASSWORD=abcdefghijklmnop
SMTP_FROM=example@gmail.com
```

**注意：** Gmail在国内可能无法访问，建议使用QQ或163邮箱

---

### 方案四：企业邮箱

如果你使用的是企业邮箱（如公司邮箱、学校邮箱），需要咨询邮箱管理员获取SMTP配置信息。

**常见企业邮箱配置：**

```bash
# 示例：企业邮箱（需要咨询管理员）
SMTP_HOST=smtp.exmail.qq.com  # 腾讯企业邮箱
SMTP_PORT=587
SMTP_USER=your-name@company.com
SMTP_PASSWORD=你的邮箱密码或授权码
SMTP_FROM=your-name@company.com
```

---

## ✅ 第三步：保存配置并重启服务

### 1. 保存配置文件

- 如果使用 `nano`：按 `Ctrl+O` 保存，按 `Ctrl+X` 退出
- 如果使用 `vi`：按 `Esc`，输入 `:wq` 保存并退出

### 2. 验证配置格式

检查配置文件是否正确（每行一个配置，不要有多余空格）：

```bash
# 查看配置
cat /opt/raspberrycloud/backend/.env | grep SMTP
```

应该看到类似输出：

```
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=123456789@qq.com
SMTP_PASSWORD=abcdefghijklmnop
SMTP_FROM=123456789@qq.com
```

### 3. 重启服务使配置生效

```bash
sudo systemctl restart raspberrycloud
```

### 4. 检查服务状态

```bash
sudo systemctl status raspberrycloud
```

确保服务正常运行（显示 `active (running)`）

---

## 🧪 第四步：测试配置

### 方法一：通过注册页面测试

1. **打开注册页面**
   - 访问 `http://树莓派IP/login.html`
   - 点击"注册"按钮

2. **测试发送验证码**
   - 填写邮箱地址
   - 点击"发送验证码"按钮
   - 查看是否收到邮件

3. **检查日志**
   - 如果发送失败，查看日志：
   ```bash
   sudo journalctl -u raspberrycloud -f
   ```

### 方法二：查看后端日志

```bash
# 实时查看日志
sudo journalctl -u raspberrycloud -f

# 查看最近50条日志
sudo journalctl -u raspberrycloud -n 50
```

**成功发送的日志示例：**

```
[EMAIL] 验证码已发送到: example@qq.com
```

**发送失败的日志示例：**

```
[EMAIL] 发送邮件失败: (535, 'Login Fail. Please enter your authorization code to login.')
```

---

## 🔍 常见问题排查

### 问题1：验证码发送失败 - "Login Fail"

**错误信息：**
```
[EMAIL] 发送邮件失败: (535, 'Login Fail. Please enter your authorization code to login.')
```

**原因：** 使用了登录密码而不是授权码

**解决方法：**
1. 确认使用的是授权码，不是邮箱登录密码
2. 重新生成授权码（QQ邮箱授权码可能已过期）
3. 检查 `.env` 文件中的 `SMTP_PASSWORD` 是否正确

---

### 问题2：验证码发送失败 - "Connection refused"

**错误信息：**
```
[EMAIL] 发送邮件失败: [Errno 111] Connection refused
```

**原因：** 网络连接问题或SMTP服务器地址/端口错误

**解决方法：**
1. 检查网络连接：`ping smtp.qq.com`
2. 确认SMTP_HOST和SMTP_PORT配置正确
3. 检查防火墙是否阻止了SMTP端口：
   ```bash
   sudo ufw status
   # 如果需要，允许SMTP端口
   sudo ufw allow 587/tcp
   ```

---

### 问题3：验证码发送失败 - "Authentication failed"

**错误信息：**
```
[EMAIL] 发送邮件失败: (535, 'Authentication failed')
```

**原因：** 授权码错误或已过期

**解决方法：**
1. 重新生成授权码
2. 确认授权码没有多余空格
3. 检查邮箱地址是否正确

---

### 问题4：开发环境测试（未配置SMTP）

如果暂时不想配置SMTP，可以在开发环境下测试：

1. **设置DEBUG模式**
   ```bash
   # 在 .env 文件中
   DEBUG=true
   ```

2. **查看控制台日志**
   - 验证码会直接打印在日志中：
   ```
   [EMAIL] 验证码: 123456 (开发模式)
   ```

3. **⚠️ 注意：** 生产环境必须配置SMTP，否则验证码会暴露在日志中，存在安全风险

---

## 📝 配置检查清单

配置完成后，请确认以下项目：

- [ ] `.env` 文件已正确编辑
- [ ] `SMTP_HOST` 配置正确（如：smtp.qq.com）
- [ ] `SMTP_PORT` 配置正确（QQ邮箱：587，163邮箱：25）
- [ ] `SMTP_USER` 是完整的邮箱地址（包含@域名）
- [ ] `SMTP_PASSWORD` 是授权码，不是登录密码
- [ ] `SMTP_FROM` 与 `SMTP_USER` 相同
- [ ] 配置文件已保存
- [ ] 服务已重启
- [ ] 测试发送验证码成功

---

## 🔒 安全建议

1. **保护授权码**
   - 不要将授权码提交到Git仓库
   - 不要分享授权码给他人
   - 定期更换授权码

2. **生产环境配置**
   - 必须配置SMTP服务器
   - 设置 `DEBUG=false`
   - 定期检查日志，确保邮件发送正常

3. **备份配置**
   - 将授权码保存在安全的地方（密码管理器）
   - 记录使用的邮箱服务商和配置信息

---

## 📊 验证码规则总结

- **长度**：6位数字
- **有效期**：10分钟
- **使用次数**：每个验证码只能使用一次
- **发送间隔**：60秒内不能重复发送
- **自动清理**：过期验证码会自动从数据库删除

---

## 🆘 获取帮助

如果遇到问题：

1. **查看日志**：`sudo journalctl -u raspberrycloud -f`
2. **检查配置**：`cat /opt/raspberrycloud/backend/.env | grep SMTP`
3. **测试网络**：`ping smtp.qq.com`
4. **重新生成授权码**：如果授权码可能已过期

---

## 📚 快速参考

### QQ邮箱配置模板

```bash
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_USER=你的QQ号@qq.com
SMTP_PASSWORD=16位授权码
SMTP_FROM=你的QQ号@qq.com
```

### 163邮箱配置模板

```bash
SMTP_HOST=smtp.163.com
SMTP_PORT=25
SMTP_USER=你的邮箱@163.com
SMTP_PASSWORD=16位授权码
SMTP_FROM=你的邮箱@163.com
```

### Gmail配置模板

```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=你的邮箱@gmail.com
SMTP_PASSWORD=16位应用专用密码
SMTP_FROM=你的邮箱@gmail.com
```

#### 163邮箱

```bash
SMTP_HOST=smtp.163.com
SMTP_PORT=25
SMTP_USER=your-email@163.com
SMTP_PASSWORD=授权码
SMTP_FROM=your-email@163.com
```

#### Gmail

```bash
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=应用专用密码  # 需要开启两步验证
SMTP_FROM=your-email@gmail.com
```

### 3. 开发环境（未配置SMTP）

如果未配置SMTP服务器，在开发环境下（`DEBUG=true`），验证码会直接打印在控制台日志中，方便测试：

```
[EMAIL] 验证码: 123456 (开发模式)
```

### 4. 重启服务

配置完成后，重启服务使配置生效：

```bash
sudo systemctl restart raspberrycloud
```

---

## 🎯 使用流程（用户端）

### 1. 用户注册流程

1. **打开注册页面**
   - 访问登录页面：`http://树莓派IP/login.html`
   - 点击"注册"按钮

2. **填写注册信息**
   - 用户名（3-20个字符）
   - 邮箱地址
   - 密码（至少8位）
   - 确认密码
   - 姓名（可选）

3. **获取验证码**
   - 点击"发送验证码"按钮
   - 系统会发送6位数字验证码到填写的邮箱
   - 按钮会显示60秒倒计时，防止重复发送

4. **输入验证码**
   - 查看邮箱收到的验证码（6位数字）
   - 在"邮箱验证码"输入框中输入验证码
   - 验证码输入框只接受数字

5. **完成注册**
   - 点击"注册"按钮
   - 系统验证验证码是否正确
   - 验证通过后创建账户
   - 注册成功后可以立即登录

---

## 📋 验证码规则

| 项目 | 说明 |
|------|------|
| **长度** | 6位数字（0-9） |
| **有效期** | 10分钟（从发送时间开始计算） |
| **使用次数** | 每个验证码只能使用一次，使用后立即失效 |
| **发送间隔** | 60秒内不能重复发送（防止恶意刷验证码） |
| **自动清理** | 过期验证码会自动从数据库删除 |

---

## 🔧 高级配置

### 修改验证码有效期

如果需要修改验证码有效期，编辑 `backend/email_verification.py`：

```python
# 找到 send_verification_code 函数
verification = save_verification_code(db, email, code, expires_minutes=10)
# 修改 expires_minutes 参数（单位：分钟）
```

### 修改发送间隔

如果需要修改发送间隔，编辑 `frontend/login.html`：

```javascript
// 找到 countdownSeconds 变量
countdownSeconds = 60;  // 修改为需要的秒数
```

---

## 📊 数据库表结构

验证码存储在 `email_verification_codes` 表中：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | Integer | 主键，自增 |
| `email` | String(100) | 邮箱地址（索引） |
| `code` | String(10) | 验证码（6位数字） |
| `created_at` | DateTime | 创建时间 |
| `expires_at` | DateTime | 过期时间 |
| `used` | Integer | 是否已使用（0=未使用，1=已使用） |

**查看验证码记录：**

```bash
# 如果使用SQLite
sqlite3 /opt/raspberrycloud/backend/raspberrycloud.db
.tables
SELECT * FROM email_verification_codes;
```

---

## ⚠️ 重要注意事项

### 1. 生产环境必须配置SMTP

- ⚠️ **未配置SMTP时，验证码会打印在日志中**
- ⚠️ **存在安全风险，任何人都可以查看日志获取验证码**
- ✅ **生产环境必须配置SMTP服务器**

### 2. 保护授权码安全

- ⚠️ **不要将授权码提交到Git仓库**
- ⚠️ **不要将授权码分享给他人**
- ✅ **使用密码管理器保存授权码**
- ✅ **定期更换授权码**

### 3. 定期检查

- ✅ **定期检查邮件发送是否正常**
- ✅ **查看日志，确保没有异常**
- ✅ **如果授权码过期，及时更新**

### 4. 测试建议

- ✅ **在开发环境先测试验证码功能**
- ✅ **确认邮件能正常发送和接收**
- ✅ **测试验证码过期和错误输入的处理**
- ✅ **确认无误后再部署到生产环境**

---

## 🆘 获取帮助

### 查看日志

```bash
# 实时查看日志
sudo journalctl -u raspberrycloud -f

# 查看最近100条日志
sudo journalctl -u raspberrycloud -n 100

# 查看包含"EMAIL"的日志
sudo journalctl -u raspberrycloud | grep EMAIL
```

### 检查配置

```bash
# 查看SMTP配置
cat /opt/raspberrycloud/backend/.env | grep SMTP

# 检查配置文件格式
cat /opt/raspberrycloud/backend/.env
```

### 测试网络连接

```bash
# 测试SMTP服务器连接
telnet smtp.qq.com 587

# 或使用nc命令
nc -zv smtp.qq.com 587
```

### 重新生成授权码

如果授权码可能已过期或泄露：

1. **QQ邮箱**：登录QQ邮箱 → 设置 → 账户 → 重新生成授权码
2. **163邮箱**：登录163邮箱 → 设置 → 重新生成授权码
3. **Gmail**：Google账户 → 安全性 → 应用专用密码 → 生成新密码

---

## 📚 快速参考表

### 常用邮箱SMTP配置速查

| 邮箱服务商 | SMTP_HOST | SMTP_PORT | 授权码获取方式 |
|-----------|-----------|-----------|---------------|
| QQ邮箱 | smtp.qq.com | 587 | 设置 → 账户 → 开启SMTP → 生成授权码 |
| 163邮箱 | smtp.163.com | 25 | 设置 → POP3/SMTP → 开启 → 生成授权码 |
| Gmail | smtp.gmail.com | 587 | 账户 → 安全性 → 两步验证 → 应用专用密码 |
| 126邮箱 | smtp.126.com | 25 | 同163邮箱 |
| 新浪邮箱 | smtp.sina.com | 25 | 设置 → 客户端设置 → 开启SMTP |

### 配置文件位置

- **配置文件**：`/opt/raspberrycloud/backend/.env`
- **日志文件**：`/var/log/raspberrycloud/`（如果配置了日志文件）
- **数据库文件**：`/opt/raspberrycloud/backend/raspberrycloud.db`（SQLite）

### 常用命令

```bash
# 编辑配置
sudo nano /opt/raspberrycloud/backend/.env

# 重启服务
sudo systemctl restart raspberrycloud

# 查看服务状态
sudo systemctl status raspberrycloud

# 查看日志
sudo journalctl -u raspberrycloud -f

# 检查配置
cat /opt/raspberrycloud/backend/.env | grep SMTP
```

---

## ✅ 配置完成检查清单

配置完成后，请逐项检查：

- [ ] 已选择邮箱服务商（QQ/163/Gmail等）
- [ ] 已获取授权码（不是登录密码）
- [ ] 已编辑 `.env` 文件
- [ ] `SMTP_HOST` 配置正确
- [ ] `SMTP_PORT` 配置正确
- [ ] `SMTP_USER` 是完整邮箱地址
- [ ] `SMTP_PASSWORD` 是授权码
- [ ] `SMTP_FROM` 与 `SMTP_USER` 相同
- [ ] 配置文件已保存
- [ ] 服务已重启
- [ ] 测试发送验证码成功
- [ ] 能收到验证码邮件
- [ ] 验证码能正常验证

---

**配置完成后，您的邮箱验证功能就可以正常使用了！** 🎉

