# RaspberryCloud æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ï¼ˆå®Œæ•´ç‰ˆï¼‰

é€‚ç”¨äºé¡¹ç›®æ ¹ç›®å½•ä¸º `RaspiOwnCloud` çš„æƒ…å†µã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

- æ ‘è“æ´¾å·²å®‰è£… Raspberry Pi OS (Bookworm) 64ä½
- å·²é€šè¿‡ SSH è¿æ¥åˆ°æ ‘è“æ´¾
- é¡¹ç›®æ–‡ä»¶å·²ä¸Šä¼ åˆ°æ ‘è“æ´¾ï¼ˆä¾‹å¦‚ï¼š`/home/pi/RaspiOwnCloud`ï¼‰

## ğŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆä½¿ç”¨è„šæœ¬ï¼‰

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/pi/RaspiOwnCloud

# 2. ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/manual_deploy.sh

# 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
sudo bash scripts/manual_deploy.sh
```

## ğŸ“ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤ï¼ˆé€æ¡æ‰§è¡Œï¼‰

### æ­¥éª¤1ï¼šæ›´æ–°ç³»ç»Ÿ

```bash
sudo apt update
sudo apt upgrade -y
```

### æ­¥éª¤2ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–

```bash
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    python3-dev \
    build-essential \
    libssl-dev \
    libffi-dev \
    sqlite3 \
    libsqlite3-dev \
    nginx \
    git \
    curl \
    wget \
    vim \
    htop \
    ufw \
    ffmpeg \
    libjpeg-dev \
    zlib1g-dev \
    samba \
    samba-common-bin
```

### æ­¥éª¤3ï¼šå®‰è£…MariaDBï¼ˆå¯é€‰ï¼Œé€‚åˆå¤šç”¨æˆ·åœºæ™¯ï¼‰

```bash
# å®‰è£…MariaDB
sudo apt install -y mariadb-server mariadb-client
sudo systemctl start mariadb
sudo systemctl enable mariadb

# å®‰å…¨é…ç½®
sudo mysql_secure_installation
# æŒ‰æç¤ºæ“ä½œï¼š
# - è®¾ç½®rootå¯†ç 
# - åˆ é™¤åŒ¿åç”¨æˆ·ï¼šY
# - ç¦æ­¢rootè¿œç¨‹ç™»å½•ï¼šY
# - åˆ é™¤æµ‹è¯•æ•°æ®åº“ï¼šY
# - é‡æ–°åŠ è½½æƒé™ï¼šY

# åˆ›å»ºåº”ç”¨æ•°æ®åº“å’Œç”¨æˆ·
sudo mysql -u root -p
```

åœ¨MySQLæç¤ºç¬¦ä¸‹æ‰§è¡Œï¼š

```sql
CREATE DATABASE raspberrycloud CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'clouduser'@'localhost' IDENTIFIED BY '2005';
GRANT ALL PRIVILEGES ON raspberrycloud.* TO 'clouduser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### æ­¥éª¤4ï¼šåˆ›å»ºåº”ç”¨ç›®å½•

```bash
sudo mkdir -p /opt/raspberrycloud
sudo mkdir -p /var/www/raspberrycloud
sudo mkdir -p /var/log/raspberrycloud
```

### æ­¥éª¤5ï¼šé€‰æ‹©å­˜å‚¨æ–¹æ¡ˆ

**SDå¡å­˜å‚¨æ–¹æ¡ˆï¼ˆæ¨èï¼Œé€‚åˆ64GB SDå¡ï¼‰ï¼š**

```bash
sudo mkdir -p /opt/raspberrycloud/storage/{users,shares,temp,backups}
STORAGE_PATH="/opt/raspberrycloud/storage"
```

**å¤–æ¥ç¡¬ç›˜å­˜å‚¨æ–¹æ¡ˆï¼š**

```bash
sudo mkdir -p /mnt/cloud_storage/{users,shares,temp,backups}
sudo chown -R www-data:www-data /mnt/cloud_storage
STORAGE_PATH="/mnt/cloud_storage"
```

### æ­¥éª¤6ï¼šè®¾ç½®ç›®å½•æƒé™

```bash
sudo chown -R www-data:www-data /opt/raspberrycloud
sudo chown -R www-data:www-data /var/www/raspberrycloud
sudo chown -R www-data:www-data /var/log/raspberrycloud
```

### æ­¥éª¤7ï¼šå¤åˆ¶é¡¹ç›®æ–‡ä»¶

å‡è®¾é¡¹ç›®åœ¨ `/home/pi/RaspiOwnCloud`ï¼š

```bash
# å¤åˆ¶åç«¯æ–‡ä»¶~/Desktop/Github/RaspiOwnCloud
sudo cp -r ~/Desktop/Github/RaspiOwnCloud/backend/* /opt/raspberrycloud/

# å¤åˆ¶å‰ç«¯æ–‡ä»¶
sudo cp -r ~/Desktop/Github/RaspiOwnCloud/frontend/* /var/www/raspberrycloud/
```

### æ­¥éª¤8ï¼šåˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ

```bash
cd /opt/raspberrycloud
sudo python3 -m venv venv
sudo chown -R www-data:www-data venv
```

### æ­¥éª¤9ï¼šå®‰è£…Pythonä¾èµ–

```bash
cd /opt/raspberrycloud
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### æ­¥éª¤10ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶é…ç½®æ¨¡æ¿
sudo cp ~/Desktop/Github/RaspiOwnCloud/config/env.example /opt/raspberrycloud/.env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /opt/raspberrycloud/.env
```

**SDå¡å­˜å‚¨æ–¹æ¡ˆé…ç½®ï¼š**

```bash
# æ•°æ®åº“é…ç½®ï¼ˆSQLiteï¼‰
DATABASE_URL=sqlite:////opt/raspberrycloud/raspberrycloud.db

# å­˜å‚¨è·¯å¾„é…ç½®
STORAGE_PATH=/opt/raspberrycloud/storage/users
SHARE_PATH=/opt/raspberrycloud/storage/shares
TEMP_PATH=/opt/raspberrycloud/storage/temp
BACKUP_PATH=/opt/raspberrycloud/storage/backups

# ç”¨æˆ·é…é¢ï¼ˆSDå¡æ–¹æ¡ˆå»ºè®®20GBï¼‰
DEFAULT_USER_QUOTA=21474836480
```

**ç”Ÿæˆå¯†é’¥ï¼š**

```bash
openssl rand -hex 32
# å°†è¾“å‡ºå¤åˆ¶åˆ° .env çš„ SECRET_KEY
```

### æ­¥éª¤11ï¼šåˆå§‹åŒ–æ•°æ®åº“

```bash
cd /opt/raspberrycloud
source venv/bin/activate
python -c "from models import init_db; init_db()"
```

### æ­¥éª¤12ï¼šé…ç½®Nginx

```bash
# å¤åˆ¶Nginxé…ç½®
sudo cp ~/Desktop/Github/RaspiOwnCloud/config/nginx.conf /etc/nginx/sites-available/raspberrycloud

# å¯ç”¨é…ç½®
sudo ln -sf /etc/nginx/sites-available/raspberrycloud /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®
sudo rm -f /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### æ­¥éª¤13ï¼šé…ç½®systemdæœåŠ¡

```bash
# å¤åˆ¶æœåŠ¡æ–‡ä»¶
sudo cp ~/Desktop/Github/RaspiOwnCloud/config/raspberrycloud.service /etc/systemd/system/

# é‡æ–°åŠ è½½systemd
sudo systemctl daemon-reload

# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl enable raspberrycloud
sudo systemctl start raspberrycloud

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status raspberrycloud
```

### æ­¥éª¤14ï¼šé…ç½®é˜²ç«å¢™

```bash
# å…è®¸SSHï¼ˆè¿œç¨‹ç™»å½•ï¼‰
sudo ufw allow 22/tcp

# å…è®¸HTTPå’ŒHTTPSï¼ˆWebè®¿é—®ï¼‰
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å…è®¸VNCï¼ˆRealVNCæ¡Œé¢è®¿é—®ï¼Œå¦‚æœä½¿ç”¨ï¼‰
sudo ufw allow 5900/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw --force enable
```

**æ³¨æ„ï¼š**
- å¦‚æœä½¿ç”¨ RealVNC è®¿é—®æ¡Œé¢ï¼Œå¿…é¡»æ·»åŠ  `sudo ufw allow 5900/tcp`
- å¦‚æœä¿®æ”¹äº† VNC ç«¯å£ï¼Œéœ€è¦ç›¸åº”ä¿®æ”¹ç«¯å£å·
- å¦‚æœä¸éœ€è¦å›¾å½¢ç•Œé¢ï¼Œå¯ä»¥è·³è¿‡ VNC ç«¯å£é…ç½®

### æ­¥éª¤15ï¼šé…ç½®Sambaï¼ˆå±€åŸŸç½‘å…±äº«ï¼‰

```bash
# æ·»åŠ Sambaé…ç½®
sudo tee -a /etc/samba/smb.conf << EOF

[cloud]
   comment = RaspberryCloud Storage
   path = /opt/raspberrycloud/storage/users
   browseable = yes
   writable = yes
   valid users = @cloud-users
   create mask = 0664
   directory mask = 0775
   force user = www-data
   force group = www-data
EOF

# åˆ›å»ºç”¨æˆ·ç»„
sudo groupadd -f cloud-users
sudo usermod -aG cloud-users www-data

# é‡å¯Samba
sudo systemctl restart smbd
sudo systemctl enable smbd
```

## âœ… éªŒè¯éƒ¨ç½²

### æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
sudo systemctl status raspberrycloud

# æ£€æŸ¥NginxæœåŠ¡
sudo systemctl status nginx

# æµ‹è¯•åç«¯API
curl http://localhost:8000/api/health

# æµ‹è¯•é€šè¿‡Nginxè®¿é—®
curl http://localhost/api/health
```

### è·å–è®¿é—®åœ°å€

```bash
# æŸ¥çœ‹æ ‘è“æ´¾IP
hostname -I
```

### è®¿é—®Webç•Œé¢

- åœ°å€ï¼š`http://æ ‘è“æ´¾IP`
- é»˜è®¤è´¦å·ï¼š`admin`
- é»˜è®¤å¯†ç ï¼š`RaspberryCloud2024!`

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start raspberrycloud

# åœæ­¢æœåŠ¡
sudo systemctl stop raspberrycloud

# é‡å¯æœåŠ¡
sudo systemctl restart raspberrycloud

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status raspberrycloud

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u raspberrycloud -f

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/raspberrycloud/backend_error.log

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/raspberrycloud_error.log
```

## ğŸ› æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u raspberrycloud -n 50 --no-pager

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /opt/raspberrycloud
source venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8000
```

### Nginx 502é”™è¯¯

```bash
# æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ
sudo systemctl status raspberrycloud

# æ£€æŸ¥ç«¯å£
curl http://localhost:8000/api/health

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/raspberrycloud_error.log
```

### æƒé™é—®é¢˜

```bash
# ä¿®å¤æƒé™
sudo chown -R www-data:www-data /opt/raspberrycloud
sudo chown -R www-data:www-data /var/www/raspberrycloud
sudo chown -R www-data:www-data /var/log/raspberrycloud
```

## ğŸ“š ä¸‹ä¸€æ­¥

1. è®¿é—®Webç•Œé¢å¹¶ç™»å½•
2. ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
3. é…ç½®HTTPSå’Œå¤–ç½‘è®¿é—®ï¼ˆå‚è€ƒï¼š`docs/03-å¤šç«¯è®¿é—®é…ç½®.md`ï¼‰
4. å®‰å…¨åŠ å›ºï¼ˆå‚è€ƒï¼š`docs/04-å®‰å…¨åŠ å›ºæŒ‡å—.md`ï¼‰

