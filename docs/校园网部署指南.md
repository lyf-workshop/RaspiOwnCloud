# 校园网部署指南

在校园网环境下部署 RaspberryCloud 的完整指南。

## 🔍 校园网特点分析

### 常见限制

| 限制类型 | 说明 | 影响 |
|---------|------|------|
| 网页认证 | 需要登录网页才能上网 | 需要配置自动认证 |
| 802.1x认证 | 需要用户名密码认证 | 需要配置WPA企业级认证 |
| 无公网IP | 校园网通常是NAT网络 | 无法直接外网访问 |
| 端口限制 | 可能封禁80/443端口 | 需要使用其他端口或内网穿透 |
| 防火墙 | 可能阻止入站连接 | 需要内网穿透 |
| 流量限制 | 可能有流量上限 | 注意流量使用 |

## 🚀 解决方案

### 方案一：校园网内访问（最简单）

**适用场景：**
- 只需要在校园网内访问
- 不需要外网访问

**配置步骤：**

1. **连接校园网WiFi**
```bash
# 在树莓派上配置WiFi
sudo raspi-config
# System Options → Wireless LAN
# 输入WiFi名称和密码
```

2. **获取树莓派IP**
```bash
hostname -I
# 例如: 10.1.2.100
```

3. **访问方式**
- 在校园网内的设备访问：`http://10.1.2.100`
- 或使用树莓派的主机名：`http://raspberrypi.local`

**优点：**
- ✅ 配置简单
- ✅ 不需要额外配置
- ✅ 访问速度快

**缺点：**
- ❌ 只能在校园网内访问
- ❌ 无法从校外访问

---

### 方案二：使用内网穿透（推荐，支持外网访问）

由于校园网通常没有公网IP，需要使用内网穿透工具。

#### 选项1：Cloudflare Tunnel（最推荐）

**优势：**
- ✅ 完全免费
- ✅ 可以使用自己的域名
- ✅ 自动HTTPS
- ✅ 不需要公网IP
- ✅ 不需要端口转发

**配置步骤：**

1. **注册Cloudflare账号**
   - 访问 https://www.cloudflare.com
   - 注册账号并添加域名

2. **在树莓派上配置**
```bash
cd ~/Desktop/Github/RaspiOwnCloud
chmod +x scripts/setup_cloudflare_tunnel.sh
sudo bash scripts/setup_cloudflare_tunnel.sh
```

详细步骤见下方。

#### 选项2：使用frp（需要服务器）

如果你有云服务器（阿里云、腾讯云等），可以使用frp。

#### 选项3：使用ngrok（临时测试）

适合临时测试，不适合长期使用。

---

## 📝 详细配置步骤

### 步骤1：连接校园网WiFi

#### 方法一：使用raspi-config（图形界面）

```bash
sudo raspi-config
# 选择: System Options → Wireless LAN
# 输入WiFi名称（SSID）
# 输入WiFi密码
```

#### 方法二：手动配置（支持网页认证）

```bash
# 编辑WiFi配置
sudo nano /etc/wpa_supplicant/wpa_supplicant.conf
```

添加配置：

```conf
network={
    ssid="校园网WiFi名称"
    psk="WiFi密码"
    # 如果是开放网络（无密码）
    # key_mgmt=NONE
}
```

**如果是802.1x企业认证：**

```conf
network={
    ssid="校园网WiFi名称"
    key_mgmt=WPA-EAP
    eap=PEAP
    identity="你的学号或用户名"
    password="你的密码"
    phase2="auth=MSCHAPV2"
}
```

```bash
# 重启网络
sudo wpa_cli -i wlan0 reconfigure
# 或
sudo systemctl restart networking
```

### 步骤2：处理网页认证

如果校园网需要网页认证，需要配置自动登录。

#### 方法一：手动登录一次

```
1. 连接WiFi后，在树莓派上打开浏览器
2. 访问任意网站，会跳转到认证页面
3. 输入账号密码登录
4. 之后保持连接即可
```

#### 方法二：使用curl自动登录（如果支持）

```bash
# 创建登录脚本
sudo nano /opt/raspberrycloud/scripts/campus_auth.sh
```

脚本内容（需要根据实际认证页面修改）：

```bash
#!/bin/bash
# 校园网自动认证脚本

USERNAME="你的学号"
PASSWORD="你的密码"
AUTH_URL="校园网认证地址"

# 发送认证请求
curl -X POST "$AUTH_URL" \
  -d "username=$USERNAME" \
  -d "password=$PASSWORD" \
  -d "action=login"

echo "认证完成"
```

```bash
chmod +x /opt/raspberrycloud/scripts/campus_auth.sh

# 添加到定时任务（每5分钟检查一次）
sudo crontab -e
# 添加: */5 * * * * /opt/raspberrycloud/scripts/campus_auth.sh
```

### 步骤3：配置内网穿透（Cloudflare Tunnel）

#### 3.1 准备Cloudflare账号

1. **注册Cloudflare**
   - 访问 https://www.cloudflare.com
   - 注册账号

2. **添加域名**
   - 登录后，点击"添加站点"
   - 输入你的域名（如：mycloud.com）
   - 选择免费计划

3. **修改DNS服务器**
   - Cloudflare会提供DNS服务器地址（如：`xxx.ns.cloudflare.com`）
   - 在域名注册商（如阿里云）处修改DNS服务器
   - 等待生效（通常几分钟到几小时）

#### 3.2 在树莓派上配置

```bash
# 1. 进入项目目录
cd ~/Desktop/Github/RaspiOwnCloud

# 2. 运行配置脚本
chmod +x scripts/setup_cloudflare_tunnel.sh
sudo bash scripts/setup_cloudflare_tunnel.sh
```

脚本会引导你完成：
- 安装 cloudflared
- 登录 Cloudflare
- 创建隧道
- 配置DNS路由
- 创建系统服务

#### 3.3 手动配置（如果脚本失败）

```bash
# 1. 下载安装 cloudflared
cd /tmp
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64
chmod +x cloudflared-linux-arm64
sudo mv cloudflared-linux-arm64 /usr/local/bin/cloudflared

# 2. 登录 Cloudflare
cloudflared tunnel login
# 会打开浏览器，点击授权

# 3. 创建隧道
cloudflared tunnel create raspberrycloud

# 4. 配置DNS路由
cloudflared tunnel route dns raspberrycloud 你的域名.com
cloudflared tunnel route dns raspberrycloud www.你的域名.com

# 5. 创建配置文件
sudo mkdir -p /etc/cloudflared
sudo nano /etc/cloudflared/config.yml
```

配置文件内容：

```yaml
tunnel: 隧道UUID（运行 cloudflared tunnel list 查看）
credentials-file: /root/.cloudflared/隧道UUID.json

ingress:
  - hostname: 你的域名.com
    service: http://localhost:80
  - hostname: www.你的域名.com
    service: http://localhost:80
  - service: http_status:404
```

```bash
# 6. 创建系统服务
sudo nano /etc/systemd/system/cloudflared.service
```

服务文件内容：

```ini
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel --config /etc/cloudflared/config.yml run
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 7. 启动服务
sudo systemctl daemon-reload
sudo systemctl enable cloudflared
sudo systemctl start cloudflared

# 8. 检查状态
sudo systemctl status cloudflared
```

### 步骤4：验证访问

1. **等待DNS生效**（5-30分钟）
2. **从任何地方访问**：`https://你的域名.com`
3. **检查HTTPS**：地址栏应该有锁图标 🔒

## 🔧 校园网特殊配置

### 处理网页认证超时

如果校园网会定期断开，需要自动重连：

```bash
# 创建自动重连脚本
sudo nano /opt/raspberrycloud/scripts/auto_reconnect.sh
```

```bash
#!/bin/bash
# 检查网络连接
if ! ping -c 1 8.8.8.8 &> /dev/null; then
    echo "网络断开，尝试重连..."
    # 重新连接WiFi
    sudo wpa_cli -i wlan0 reconnect
    # 等待连接
    sleep 10
    # 执行认证（如果有）
    /opt/raspberrycloud/scripts/campus_auth.sh
fi
```

```bash
chmod +x /opt/raspberrycloud/scripts/auto_reconnect.sh

# 添加到定时任务（每10分钟检查一次）
sudo crontab -e
# 添加: */10 * * * * /opt/raspberrycloud/scripts/auto_reconnect.sh
```

### 处理IP变化

如果校园网IP会变化，确保服务配置使用localhost：

```bash
# 检查服务配置
sudo nano /etc/systemd/system/raspberrycloud.service
# 确保使用 127.0.0.1 而不是 0.0.0.0
```

## ✅ 部署检查清单

- [ ] 树莓派已连接校园网WiFi
- [ ] 校园网认证已完成（如果需要）
- [ ] 树莓派可以正常上网（ping 8.8.8.8）
- [ ] Cloudflare账号已注册
- [ ] 域名已添加到Cloudflare
- [ ] DNS服务器已修改
- [ ] Cloudflare Tunnel已配置
- [ ] 服务已启动
- [ ] 外网访问测试成功

## 🐛 常见问题

### Q1: 无法连接校园网WiFi

**可能原因：**
- WiFi需要网页认证
- 需要802.1x企业认证
- MAC地址绑定

**解决方案：**
```bash
# 查看连接状态
sudo wpa_cli status

# 查看连接日志
sudo journalctl -u wpa_supplicant -f
```

### Q2: 连接后无法上网

**检查：**
```bash
# 测试网络连接
ping 8.8.8.8

# 如果无法ping通，可能需要网页认证
# 在树莓派上打开浏览器访问任意网站
```

### Q3: Cloudflare Tunnel连接失败

**检查：**
```bash
# 查看服务状态
sudo systemctl status cloudflared

# 查看日志
sudo journalctl -u cloudflared -f

# 测试连接
cloudflared tunnel info
```

### Q4: 校园网限制流量

**建议：**
- 限制文件上传大小
- 定期清理临时文件
- 监控流量使用

## 🎉 完成！

配置完成后，你可以：
- ✅ 在校园网内访问：`http://树莓派IP`
- ✅ 从任何地方访问：`https://你的域名.com`

**访问地址：**
- 校园网内：`http://树莓派IP`（如：`http://10.1.2.100`）
- 外网访问：`https://你的域名.com`


