# 香港服务器迁移指南

从国内服务器迁移到香港服务器，实现无需备案的域名访问。

## 📋 迁移前准备

### 为什么要迁移？

**国内服务器的问题：**
- ❌ 域名访问必须ICP备案
- ❌ 备案需要2-3周时间
- ❌ 备案流程复杂
- ❌ 个人备案限制多

**香港服务器的优势：**
- ✅ 域名访问无需备案
- ✅ 立即可用
- ✅ 国内访问速度良好
- ✅ 配置完全相同

### 成本对比

```
国内服务器：38元/年（需要备案）
香港服务器：288元/年（无需备案）

差价：250元/年
省去：备案时间和精力
```

---

## 🛒 第1步：购买香港轻量服务器

### 1.1 访问阿里云

```
https://www.aliyun.com/product/swas
或
https://swas.console.aliyun.com/
```

### 1.2 选择配置

**关键配置：**

```
地域：中国香港 ⭐ 必须选香港！
镜像：Ubuntu 22.04 LTS
套餐选择：

推荐套餐1（家庭使用）：
  CPU：1核
  内存：1GB
  带宽：30Mbps
  流量：1TB/月
  价格：24元/月，288元/年

推荐套餐2（多人使用）：
  CPU：2核
  内存：2GB
  带宽：30Mbps
  流量：2TB/月
  价格：34元/月，408元/年
```

**建议：**
- 首次购买可以选1个月，测试稳定后再续费1年
- 年付有优惠

### 1.3 配置防火墙

购买时或购买后在控制台配置：

```
规则1：FRP通信端口
端口：7000
协议：TCP

规则2：HTTP
端口：80
协议：TCP

规则3：HTTPS
端口：443
协议：TCP

规则4：FRP控制台（可选）
端口：7500
协议：TCP
```

### 1.4 记录信息

购买完成后记录：

```
香港服务器公网IP：________________
root密码：________________
购买时间：________________
到期时间：________________
```

---

## 🔧 第2步：配置香港服务器

### 2.1 SSH连接到香港服务器

```bash
# 从您的电脑连接
ssh root@香港服务器IP

# 输入密码
```

### 2.2 更新系统

```bash
# 更新软件包列表
apt update

# 升级系统（可选）
apt upgrade -y
```

### 2.3 安装FRP服务端

**方法一：使用自动脚本**

```bash
# 下载安装脚本
wget https://raw.githubusercontent.com/yourusername/RaspiOwnCloud/main/scripts/install_frps.sh

# 添加执行权限
chmod +x install_frps.sh

# 运行安装
bash install_frps.sh
```

**重要：记录显示的Token！**

```
=== FRP服务端安装完成 ===
FRP Token: abc123def456ghi789  ← 记下这个！
请将此Token记录下来，配置客户端时需要使用！
```

**方法二：手动安装**

如果脚本下载失败，参考《FRP内网穿透部署完整教程.md》的"附录A"。

### 2.4 验证服务运行

```bash
# 检查服务状态
systemctl status frps

# 查看日志
tail -f /var/log/frp/frps.log

# 检查端口监听
ss -tunlp | grep frps
```

应该看到：
```
0.0.0.0:7000  (FRP通信端口)
0.0.0.0:80    (HTTP)
0.0.0.0:443   (HTTPS)
0.0.0.0:7500  (控制台)
```

---

## 🍓 第3步：修改树莓派配置

### 3.1 停止当前FRP客户端

```bash
# SSH连接到树莓派
ssh pi@树莓派IP

# 停止FRP服务
sudo systemctl stop frpc
```

### 3.2 备份当前配置（可选但推荐）

```bash
# 备份配置文件
sudo cp /etc/frp/frpc.ini /etc/frp/frpc.ini.backup

# 如需恢复：
# sudo cp /etc/frp/frpc.ini.backup /etc/frp/frpc.ini
```

### 3.3 修改FRP客户端配置

```bash
# 编辑配置文件
sudo nano /etc/frp/frpc.ini
```

**修改以下内容：**

```ini
[common]
# 修改服务器地址为香港服务器IP
server_addr = 香港服务器IP  # 原来是国内服务器IP
server_port = 7000

# 修改Token为香港服务器的Token
token = 新的Token  # 从香港服务器安装时获取

# 其他配置保持不变
tcp_mux = true
pool_count = 5
heartbeat_interval = 30
heartbeat_timeout = 90

# HTTP和HTTPS代理配置不变
[raspberrycloud-http]
type = http
local_ip = 127.0.0.1
local_port = 80
custom_domains = piowncloud.com

[raspberrycloud-https]
type = https
local_ip = 127.0.0.1
local_port = 443
custom_domains = piowncloud.com
```

**保存并退出：**
- Ctrl+O（保存）
- Enter（确认）
- Ctrl+X（退出）

### 3.4 启动FRP客户端

```bash
# 启动服务
sudo systemctl start frpc

# 查看日志
sudo journalctl -u frpc -f
```

**成功标志：**
```
[I] login to server success
[I] [raspberrycloud-http] start proxy success
[I] [raspberrycloud-https] start proxy success
```

### 3.5 测试新服务器连接

```bash
# 测试Ping
ping -c 4 香港服务器IP

# 测试端口
nc -zv 香港服务器IP 7000
```

---

## 🌐 第4步：修改DNS解析

### 4.1 登录阿里云DNS控制台

```
https://dns.console.aliyun.com/
```

### 4.2 修改A记录

1. 找到域名 `piowncloud.com`
2. 点击"解析设置"
3. 找到主机记录为 `@` 的A记录
4. 点击"修改"

**修改内容：**
```
记录类型：A（不变）
主机记录：@（不变）
解析线路：默认（不变）
记录值：从 国内服务器IP 改为 香港服务器IP
TTL：600（不变）
```

5. 点击"确认"保存

### 4.3 修改www记录（如果有）

如果配置了www子域名，也需要修改：

```
主机记录：www
记录值：改为 香港服务器IP
```

### 4.4 等待DNS生效

```bash
# 检查DNS解析（在树莓派或您的电脑）
nslookup piowncloud.com

# 应该返回香港服务器IP
# 注意：DNS生效需要5-10分钟
```

---

## 🔄 第5步：切换Nginx配置

### 5.1 修改Nginx配置

```bash
# 在树莓派上

# 编辑Nginx配置
sudo nano /etc/nginx/sites-available/raspberrycloud
```

**找到 `server_name` 行：**

```nginx
# 如果之前改成了 _（IP访问）
server_name _;

# 改回域名
server_name piowncloud.com;

# 如果有www，也可以加上
server_name piowncloud.com www.piowncloud.com;
```

### 5.2 测试并重启Nginx

```bash
# 测试配置
sudo nginx -t

# 应该显示：
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# 重新加载配置
sudo systemctl reload nginx
```

---

## ✅ 第6步：测试和验证

### 6.1 检查FRP隧道

**在香港服务器：**
```bash
# 查看日志
tail -f /var/log/frp/frps.log

# 应该看到客户端连接记录
```

**在树莓派：**
```bash
# 查看状态
sudo systemctl status frpc

# 查看日志
sudo journalctl -u frpc -n 20
```

### 6.2 测试域名访问

```bash
# DNS解析测试
nslookup piowncloud.com

# HTTP测试
curl -I http://piowncloud.com

# 浏览器测试
# 打开：http://piowncloud.com
```

### 6.3 功能测试

1. 登录系统
2. 上传文件
3. 下载文件
4. 创建文件夹
5. 分享文件

### 6.4 外网测试

- 用手机4G/5G网络访问
- 从朋友的网络访问
- 确认外网可以正常使用

---

## 🗑️ 第7步：清理旧服务器（可选）

### 7.1 确认迁移成功

**检查清单：**
```
□ DNS已解析到香港服务器
□ 域名可以正常访问
□ 所有功能正常
□ 外网访问正常
□ 已稳定运行3天以上
```

### 7.2 备份旧服务器配置

```bash
# SSH到国内服务器
ssh root@国内服务器IP

# 备份配置
cat /etc/frp/frps.ini > ~/frps_config_backup.txt
cat /root/frp_config.txt >> ~/frps_config_backup.txt

# 下载备份（在您的电脑）
scp root@国内服务器IP:~/frps_config_backup.txt ./
```

### 7.3 删除国内服务器

**选项A：完全删除（不再使用）**

在阿里云控制台：
1. 进入轻量应用服务器
2. 找到国内服务器
3. 点击"释放"或"删除"
4. 确认删除

**选项B：保留作备份（推荐）**

- 保留国内服务器作为IP访问备份
- 只增加38元/年成本
- 万一香港服务器出问题可以快速切换

---

## 🔒 第8步：配置HTTPS（可选）

迁移完成后，可以配置HTTPS证书：

### 8.1 在香港服务器安装Certbot

```bash
# SSH到香港服务器
ssh root@香港服务器IP

# 安装Certbot
apt install -y certbot
```

### 8.2 申请SSL证书

```bash
# 停止FRP（释放80端口）
systemctl stop frps

# 申请证书
certbot certonly --standalone -d piowncloud.com -d www.piowncloud.com

# 按提示操作：
# 1. 输入邮箱
# 2. 同意服务条款
# 3. 等待验证完成

# 重启FRP
systemctl start frps
```

### 8.3 配置自动续期

```bash
# 添加定时任务
crontab -e

# 添加以下行（每月1日凌晨3点检查续期）
0 3 1 * * certbot renew --quiet --pre-hook "systemctl stop frps" --post-hook "systemctl start frps"
```

### 8.4 测试HTTPS访问

```bash
# 浏览器访问
https://piowncloud.com

# 应该看到锁图标，证书有效
```

---

## 📊 迁移前后对比

### 迁移前（国内服务器）

```
✅ FRP隧道正常
❌ 域名需要备案才能访问
⚠️ 只能用IP访问：http://39.104.94.53
💰 成本：38元/年
```

### 迁移后（香港服务器）

```
✅ FRP隧道正常
✅ 域名直接可用：http://piowncloud.com
✅ 可以配置HTTPS：https://piowncloud.com
✅ 无需备案
💰 成本：288元/年
```

---

## 🔧 故障排查

### Q1: 树莓派无法连接香港服务器

```bash
# 1. 检查香港服务器FRP运行
ssh root@香港服务器IP
systemctl status frps

# 2. 检查防火墙
# 登录阿里云控制台，确认7000端口已开放

# 3. 测试网络
ping 香港服务器IP
nc -zv 香港服务器IP 7000

# 4. 检查Token
cat /etc/frp/frpc.ini | grep token  # 树莓派
cat /etc/frp/frps.ini | grep token  # 香港服务器
# 确保两者一致
```

### Q2: 域名无法访问

```bash
# 1. 检查DNS解析
nslookup piowncloud.com
# 应该返回香港服务器IP

# 2. 等待DNS生效（最多1小时）

# 3. 清除DNS缓存
# Windows: ipconfig /flushdns
# Mac: sudo dscacheutil -flushcache
# Linux: sudo systemd-resolve --flush-caches

# 4. 检查Nginx配置
sudo nginx -t
sudo systemctl status nginx
```

### Q3: 香港服务器访问速度慢

```bash
# 测试延迟
ping 香港服务器IP

# 国内访问香港通常：
# 华南（广东）：10-30ms
# 华东（江浙沪）：30-50ms
# 华北（京津冀）：50-80ms
# 其他地区：80-150ms

# 如果延迟过高（>200ms），可以考虑：
# 1. 换其他地区节点
# 2. 升级带宽套餐
```

---

## 💡 最佳实践

### 1. 渐进式迁移

```
第1天：购买香港服务器，完成基础配置
第2天：修改树莓派配置，测试连接
第3天：修改DNS，测试域名访问
第4-7天：持续监控稳定性
第8天：确认稳定，配置HTTPS
第14天：考虑是否删除国内服务器
```

### 2. 保留双服务器备份

```
主力：香港服务器 + 域名访问
备份：国内服务器 + IP访问

成本：38+288=326元/年
优势：有备份，更可靠
```

### 3. 监控和维护

```bash
# 定期检查FRP状态
sudo systemctl status frpc

# 查看日志
sudo journalctl -u frpc --since "1 day ago"

# 使用监控脚本
bash scripts/frp_status.sh
```

---

## 📝 完成检查清单

```
□ 购买香港轻量服务器
□ 配置防火墙规则
□ 在香港服务器安装FRP服务端
□ 记录新Token
□ 修改树莓派FRP客户端配置
□ 重启树莓派FRP客户端
□ 确认连接成功（login to server success）
□ 修改DNS解析（指向香港服务器）
□ 等待DNS生效
□ 修改Nginx配置（改回域名）
□ 测试域名访问
□ 测试外网访问
□ （可选）配置HTTPS证书
□ （可选）删除国内服务器
```

---

## 🎉 完成

恭喜！您已成功从国内服务器迁移到香港服务器！

现在您可以：
- ✅ 使用域名访问：`http://piowncloud.com`
- ✅ 无需备案，立即可用
- ✅ 国内访问速度良好
- ✅ 树莓派可以随意更换网络

**下一步：**
- 配置HTTPS证书（推荐）
- 设置自动监控
- 享受您的私有云服务！

---

## 📞 获取帮助

如果迁移过程中遇到问题：

1. 查看日志：`sudo journalctl -u frpc -f`
2. 参考《FRP快速参考指南.md》
3. 使用状态检查：`bash scripts/frp_status.sh`

祝您使用愉快！🎊










