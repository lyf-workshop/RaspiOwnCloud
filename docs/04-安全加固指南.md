# 安全加固指南

本文档详细说明如何加固树莓派私有云存储系统的安全性。

## 🔐 安全威胁概览

| 威胁类型 | 风险等级 | 防护措施 |
|---------|---------|---------|
| 暴力破解 | 高 | 强密码+失败锁定+SSH密钥 |
| 未授权访问 | 高 | 防火墙+HTTPS+认证 |
| 数据泄露 | 高 | 加密传输+权限控制 |
| 恶意文件 | 中 | 文件扫描+类型限制 |
| DDoS攻击 | 中 | 流量限制+Fail2ban |
| 物理安全 | 低 | 设备上锁+监控 |

## 🛡️ 一、系统层安全

### 1.1 禁止root直接登录

```bash
# 创建普通用户（如果还没有）
sudo adduser cloud
sudo usermod -aG sudo cloud

# 编辑SSH配置
sudo nano /etc/ssh/sshd_config
```

修改以下配置：

```
# 禁止root登录
PermitRootLogin no

# 禁止空密码
PermitEmptyPasswords no

# 限制认证尝试次数
MaxAuthTries 3

# 启用公钥认证
PubkeyAuthentication yes

# 禁用密码认证（配置SSH密钥后）
# PasswordAuthentication no
```

```bash
# 重启SSH服务
sudo systemctl restart ssh
```

### 1.2 配置SSH密钥认证

**在本地电脑生成密钥对：**

```bash
# Mac/Linux
ssh-keygen -t ed25519 -C "your_email@example.com"

# Windows（PowerShell）
ssh-keygen -t ed25519 -C "your_email@example.com"

# 按提示操作：
# 1. 保存位置（默认~/.ssh/id_ed25519）
# 2. 设置密钥密码（可选但推荐）
```

**复制公钥到树莓派：**

```bash
# Mac/Linux
ssh-copy-id pi@树莓派IP

# 或手动复制
cat ~/.ssh/id_ed25519.pub | ssh pi@树莓派IP "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"

# Windows（在树莓派上执行）
mkdir -p ~/.ssh
nano ~/.ssh/authorized_keys
# 粘贴本地的 id_ed25519.pub 内容
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys
```

**测试密钥登录：**

```bash
ssh -i ~/.ssh/id_ed25519 pi@树莓派IP
```

**禁用密码登录（测试成功后）：**

```bash
sudo nano /etc/ssh/sshd_config
# 修改: PasswordAuthentication no
sudo systemctl restart ssh
```

### 1.3 修改SSH端口（可选）

```bash
sudo nano /etc/ssh/sshd_config

# 修改端口（选择1024-65535之间的未使用端口）
Port 2222
```

```bash
# 更新防火墙规则
sudo ufw allow 2222/tcp
sudo ufw delete allow 22/tcp

# 重启SSH
sudo systemctl restart ssh
```

**后续登录命令：**

```bash
ssh -p 2222 pi@树莓派IP
```

### 1.4 配置防火墙（UFW）

```bash
# 启用UFW
sudo ufw enable

# 默认策略（拒绝所有入站，允许所有出站）
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH（根据实际端口修改）
sudo ufw allow 22/tcp

# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许Samba（仅局域网，推荐）
sudo ufw allow from 192.168.1.0/24 to any port 445

# 查看规则
sudo ufw status numbered

# 删除规则（按编号）
sudo ufw delete 5

# 重置防火墙（小心！）
sudo ufw reset
```

### 1.5 安装Fail2ban（防暴力破解）

```bash
# 安装Fail2ban
sudo apt install fail2ban

# 创建本地配置
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo nano /etc/fail2ban/jail.local
```

配置内容：

```ini
[DEFAULT]
# 封禁时间（秒）
bantime = 3600
# 监控时间窗口（秒）
findtime = 600
# 最大尝试次数
maxretry = 3
# 忽略IP（自己的IP）
ignoreip = 127.0.0.1/8 192.168.1.0/24

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log
maxretry = 3

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/raspberrycloud_error.log
maxretry = 5

[nginx-noscript]
enabled = true
port = http,https
logpath = /var/log/nginx/raspberrycloud_access.log
maxretry = 6
```

```bash
# 启动Fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 查看状态
sudo fail2ban-client status

# 查看SSH规则状态
sudo fail2ban-client status sshd

# 解封IP
sudo fail2ban-client set sshd unbanip 192.168.1.100
```

### 1.6 配置自动安全更新

```bash
# 安装unattended-upgrades
sudo apt install unattended-upgrades

# 配置
sudo dpkg-reconfigure -plow unattended-upgrades

# 编辑配置（可选）
sudo nano /etc/apt/apt.conf.d/50unattended-upgrades
```

推荐配置：

```
Unattended-Upgrade::Automatic-Reboot "false";
Unattended-Upgrade::Automatic-Reboot-Time "03:00";
Unattended-Upgrade::Mail "your@email.com";
```

## 🔒 二、应用层安全

### 2.1 修改默认管理员密码

```bash
# 方法一：通过Web界面
# 登录后 → 用户设置 → 修改密码

# 方法二：通过API
curl -X POST http://localhost/api/auth/change-password \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "old_password=RaspberryCloud2024!" \
  -F "new_password=你的新密码"
```

**强密码要求：**
- 至少12位
- 包含大小写字母
- 包含数字
- 包含特殊字符
- 不包含用户名或常见词

### 2.2 更新SECRET_KEY

```bash
# 生成新密钥
openssl rand -hex 32

# 更新配置
sudo nano /opt/raspberrycloud/backend/.env

# 修改SECRET_KEY为新生成的值
SECRET_KEY=新生成的密钥

# 重启服务
sudo systemctl restart raspberrycloud
```

⚠️ **注意**：更新SECRET_KEY会使所有现有token失效，用户需要重新登录。

### 2.3 限制文件上传

```bash
sudo nano /opt/raspberrycloud/backend/.env
```

配置：

```
# 单文件最大大小（10GB）
MAX_FILE_SIZE=10737418240

# 允许的文件类型（在config.py中配置）
# 禁止上传可执行文件：.exe, .bat, .sh, .app等
```

编辑`config.py`添加黑名单：

```python
# 禁止上传的文件类型
BLOCKED_EXTENSIONS = {
    '.exe', '.bat', '.cmd', '.com', '.pif',
    '.sh', '.app', '.deb', '.rpm',
    '.msi', '.dll', '.so', '.dylib'
}
```

### 2.4 配置用户配额

```bash
# 通过API设置用户配额（管理员）
curl -X PUT http://localhost/api/admin/users/2/quota \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -F "new_quota=107374182400"  # 100GB
```

### 2.5 启用访问日志审计

```bash
# 创建日志分析脚本
sudo nano /opt/raspberrycloud/scripts/log_analyzer.sh
```

```bash
#!/bin/bash
# 分析异常访问

echo "=== 最近24小时异常访问 ==="

# 404错误
echo "404错误 (前10):"
grep "\" 404 " /var/log/nginx/raspberrycloud_access.log | \
  awk '{print $1}' | sort | uniq -c | sort -rn | head -10

# 失败的登录尝试
echo "失败的登录尝试:"
grep "401" /var/log/nginx/raspberrycloud_access.log | \
  grep "/api/auth/login" | wc -l

# 大量请求的IP
echo "请求最多的IP (前10):"
awk '{print $1}' /var/log/nginx/raspberrycloud_access.log | \
  sort | uniq -c | sort -rn | head -10
```

```bash
chmod +x /opt/raspberrycloud/scripts/log_analyzer.sh

# 设置定时任务（每天运行）
crontab -e
# 添加: 0 2 * * * /opt/raspberrycloud/scripts/log_analyzer.sh > /var/log/raspberrycloud/analysis.log
```

## 🔐 三、网络层安全

### 3.1 强制HTTPS

编辑Nginx配置：

```bash
sudo nano /etc/nginx/sites-available/raspberrycloud
```

在HTTP server块中添加重定向：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 强制重定向到HTTPS
    return 301 https://$server_name$request_uri;
}
```

### 3.2 配置HTTPS安全头

在HTTPS server块中添加：

```nginx
# 安全头
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;" always;

# 禁止目录列表
autoindex off;
```

### 3.3 限制请求速率

```nginx
# 在http块中添加
limit_req_zone $binary_remote_addr zone=login:10m rate=3r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=60r/m;

# 在location块中应用
location /api/auth/login {
    limit_req zone=login burst=5 nodelay;
    # ... 其他配置
}

location /api/ {
    limit_req zone=api burst=20 nodelay;
    # ... 其他配置
}
```

### 3.4 配置IP白名单（可选）

```nginx
# 仅允许特定IP访问管理接口
location /api/admin/ {
    allow 192.168.1.0/24;  # 允许局域网
    allow 123.456.789.0;    # 允许特定公网IP
    deny all;
    
    # ... 其他配置
}
```

## 💾 四、数据安全

### 4.1 配置自动备份

```bash
# 编辑备份脚本
sudo nano /opt/raspberrycloud/scripts/backup.sh

# 设置定时备份
sudo crontab -e

# 添加任务（每天凌晨3点备份）
0 3 * * * /opt/raspberrycloud/scripts/backup.sh >> /var/log/raspberrycloud/backup.log 2>&1
```

### 4.2 备份到远程服务器（可选）

```bash
# 安装rsync
sudo apt install rsync

# 创建SSH密钥（用于远程备份）
sudo ssh-keygen -t ed25519 -f /root/.ssh/backup_key

# 复制公钥到远程服务器
sudo ssh-copy-id -i /root/.ssh/backup_key.pub user@remote-server

# 创建远程备份脚本
sudo nano /opt/raspberrycloud/scripts/remote_backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/mnt/cloud_storage/backups"
REMOTE_USER="user"
REMOTE_HOST="remote-server"
REMOTE_DIR="/backups/raspberrycloud"

# 同步备份到远程服务器
rsync -avz -e "ssh -i /root/.ssh/backup_key" \
  "$BACKUP_DIR/" \
  "$REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR/"
```

### 4.3 加密备份（可选）

```bash
# 安装gpg
sudo apt install gnupg

# 生成GPG密钥
sudo gpg --gen-key

# 加密备份
sudo gpg --encrypt --recipient your@email.com backup.tar.gz

# 解密备份
sudo gpg --decrypt backup.tar.gz.gpg > backup.tar.gz
```

### 4.4 文件权限检查

```bash
# 检查关键文件权限
sudo ls -la /opt/raspberrycloud/backend/.env
# 应为: -rw------- (600)

sudo ls -la /mnt/cloud_storage
# 应为: drwxr-xr-x (755) www-data:www-data

# 修复权限
sudo chmod 600 /opt/raspberrycloud/backend/.env
sudo chown -R www-data:www-data /mnt/cloud_storage
sudo chmod -R 755 /mnt/cloud_storage
```

## 🛡️ 五、病毒扫描（可选）

### 5.1 安装ClamAV

```bash
# 安装ClamAV
sudo apt install clamav clamav-daemon

# 停止服务更新病毒库
sudo systemctl stop clamav-freshclam

# 手动更新病毒库
sudo freshclam

# 启动服务
sudo systemctl start clamav-freshclam
sudo systemctl enable clamav-daemon
```

### 5.2 配置定期扫描

```bash
# 创建扫描脚本
sudo nano /opt/raspberrycloud/scripts/virus_scan.sh
```

```bash
#!/bin/bash
SCAN_DIR="/mnt/cloud_storage/users"
LOG_FILE="/var/log/raspberrycloud/clamav.log"

echo "=== ClamAV扫描 $(date) ===" >> "$LOG_FILE"
clamscan -r -i --log="$LOG_FILE" "$SCAN_DIR"

# 发送邮件通知（如果发现病毒）
if grep -q "Infected files:" "$LOG_FILE"; then
    echo "发现病毒！查看日志: $LOG_FILE" | mail -s "病毒扫描警告" your@email.com
fi
```

```bash
chmod +x /opt/raspberrycloud/scripts/virus_scan.sh

# 设置定时扫描（每周日凌晨2点）
sudo crontab -e
# 添加: 0 2 * * 0 /opt/raspberrycloud/scripts/virus_scan.sh
```

## 📊 六、监控与告警

### 6.1 配置系统监控

```bash
# 安装Prometheus Node Exporter（可选）
sudo apt install prometheus-node-exporter

# 或使用简单脚本
sudo nano /opt/raspberrycloud/scripts/health_check.sh
```

```bash
#!/bin/bash
# 健康检查脚本

# 检查服务状态
if ! systemctl is-active --quiet raspberrycloud; then
    echo "RaspberryCloud服务已停止！" | mail -s "服务告警" your@email.com
    systemctl restart raspberrycloud
fi

# 检查磁盘使用率
DISK_USAGE=$(df -h /mnt/cloud_storage | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 90 ]; then
    echo "存储空间使用率超过90%！" | mail -s "存储告警" your@email.com
fi

# 检查CPU温度
TEMP=$(vcgencmd measure_temp | egrep -o '[0-9]*\.[0-9]*')
if (( $(echo "$TEMP > 80" | bc -l) )); then
    echo "CPU温度过高: ${TEMP}°C" | mail -s "温度告警" your@email.com
fi
```

```bash
chmod +x /opt/raspberrycloud/scripts/health_check.sh

# 每5分钟检查一次
crontab -e
# 添加: */5 * * * * /opt/raspberrycloud/scripts/health_check.sh
```

### 6.2 配置邮件通知

```bash
# 安装邮件工具
sudo apt install mailutils postfix

# 配置Postfix（选择"Internet Site"）
sudo dpkg-reconfigure postfix

# 测试发送邮件
echo "测试邮件" | mail -s "测试" your@email.com
```

## ✅ 安全检查清单

### 系统安全
- [ ] 已禁用root直接登录
- [ ] 已配置SSH密钥认证
- [ ] 已修改SSH默认端口（可选）
- [ ] 已配置UFW防火墙
- [ ] 已安装Fail2ban
- [ ] 已启用自动安全更新

### 应用安全
- [ ] 已修改默认管理员密码
- [ ] 已更新SECRET_KEY
- [ ] 已配置文件上传限制
- [ ] 已设置用户配额
- [ ] 已启用访问日志审计

### 网络安全
- [ ] 已强制HTTPS
- [ ] 已配置安全头
- [ ] 已限制请求速率
- [ ] 已配置IP白名单（可选）

### 数据安全
- [ ] 已配置自动备份
- [ ] 已测试备份恢复
- [ ] 已检查文件权限
- [ ] 已配置病毒扫描（可选）

### 监控告警
- [ ] 已配置系统监控
- [ ] 已配置邮件通知
- [ ] 已测试告警机制

## 🔍 安全审计

定期执行以下检查：

```bash
# 检查登录日志
sudo tail -100 /var/log/auth.log

# 检查Nginx访问日志
sudo tail -100 /var/log/nginx/raspberrycloud_access.log

# 检查系统用户
sudo cat /etc/passwd

# 检查sudo权限
sudo cat /etc/sudoers

# 检查开放端口
sudo netstat -tulpn

# 检查运行进程
ps aux | grep -E 'nginx|uvicorn|python'

# 检查系统更新
sudo apt update && apt list --upgradable
```

## 🎉 完成

安全加固完成！系统现在已经具备：
- ✅ 多层防护（系统、应用、网络）
- ✅ 自动备份和监控
- ✅ 入侵防护和检测
- ✅ 数据加密传输

接下来查看 [问题排查手册](05-问题排查手册.md) 学习故障诊断。


