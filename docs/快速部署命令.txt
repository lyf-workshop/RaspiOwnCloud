# RaspberryCloud 快速部署命令（树莓派上执行）
# 项目根目录：RaspiOwnCloud
# 假设项目在：/home/pi/RaspiOwnCloud

# ============================================
# 方式一：使用自动部署脚本（推荐）
# ============================================

cd /home/pi/RaspiOwnCloud
chmod +x scripts/manual_deploy.sh
sudo bash scripts/manual_deploy.sh


# ============================================
# 方式二：手动部署（逐条执行）
# ============================================

# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装系统依赖
sudo apt install -y python3 python3-pip python3-venv python3-dev build-essential libssl-dev libffi-dev sqlite3 libsqlite3-dev nginx git curl wget vim htop ufw ffmpeg libjpeg-dev zlib1g-dev samba samba-common-bin

# 3. 创建应用目录
sudo mkdir -p /opt/raspberrycloud
sudo mkdir -p /var/www/raspberrycloud
sudo mkdir -p /var/log/raspberrycloud
sudo mkdir -p /opt/raspberrycloud/storage/{users,shares,temp,backups}

# 4. 设置权限
sudo chown -R www-data:www-data /opt/raspberrycloud
sudo chown -R www-data:www-data /var/www/raspberrycloud
sudo chown -R www-data:www-data /var/log/raspberrycloud

# 5. 复制项目文件（假设项目在 /home/pi/RaspiOwnCloud）
sudo cp -r /home/pi/RaspiOwnCloud/backend/* /opt/raspberrycloud/
sudo cp -r /home/pi/RaspiOwnCloud/frontend/* /var/www/raspberrycloud/

# 6. 创建Python虚拟环境
cd /opt/raspberrycloud
sudo python3 -m venv venv
sudo chown -R www-data:www-data venv

# 7. 安装Python依赖
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 8. 配置环境变量
sudo cp /home/pi/RaspiOwnCloud/config/env.example /opt/raspberrycloud/.env

# 生成密钥并更新配置
SECRET_KEY=$(openssl rand -hex 32)
sudo sed -i "s/your-secret-key-change-this-in-production-use-openssl-rand-hex-32/$SECRET_KEY/" /opt/raspberrycloud/.env

# 配置SD卡存储路径
sudo sed -i "s|STORAGE_PATH=/mnt/cloud_storage/users|STORAGE_PATH=/opt/raspberrycloud/storage/users|" /opt/raspberrycloud/.env
sudo sed -i "s|SHARE_PATH=/mnt/cloud_storage/shares|SHARE_PATH=/opt/raspberrycloud/storage/shares|" /opt/raspberrycloud/.env
sudo sed -i "s|TEMP_PATH=/mnt/cloud_storage/temp|TEMP_PATH=/opt/raspberrycloud/storage/temp|" /opt/raspberrycloud/.env
sudo sed -i "s|BACKUP_PATH=/mnt/cloud_storage/backups|BACKUP_PATH=/opt/raspberrycloud/storage/backups|" /opt/raspberrycloud/.env
sudo sed -i "s|DEFAULT_USER_QUOTA=107374182400|DEFAULT_USER_QUOTA=21474836480|" /opt/raspberrycloud/.env

# 9. 初始化数据库
cd /opt/raspberrycloud
source venv/bin/activate
python -c "from models import init_db; init_db()"

# 10. 配置Nginx
sudo cp /home/pi/RaspiOwnCloud/config/nginx.conf /etc/nginx/sites-available/raspberrycloud
sudo ln -sf /etc/nginx/sites-available/raspberrycloud /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t
sudo systemctl restart nginx
sudo systemctl enable nginx

# 11. 配置systemd服务
sudo cp /home/pi/RaspiOwnCloud/config/raspberrycloud.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable raspberrycloud
sudo systemctl start raspberrycloud

# 12. 配置防火墙
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# 13. 配置Samba
sudo tee -a /etc/samba/smb.conf << 'EOF'

[cloud]
   comment = RaspberryCloud Storage
   path = /opt/raspberrycloud/storage/users
   browseable = yes
   writable = yes
   valid users = @cloud-users
   create mask = 0664
   directory mask = 0775
   force user = www-data
   force group = www-data
EOF

sudo groupadd -f cloud-users
sudo usermod -aG cloud-users www-data
sudo systemctl restart smbd
sudo systemctl enable smbd

# 14. 检查服务状态
sudo systemctl status raspberrycloud
sudo systemctl status nginx

# 15. 获取访问地址
echo "访问地址: http://$(hostname -I | awk '{print $1}')"
echo "默认账号: admin"
echo "默认密码: RaspberryCloud2024!"


# ============================================
# 验证部署
# ============================================

# 测试后端API
curl http://localhost:8000/api/health

# 测试通过Nginx访问
curl http://localhost/api/health

# 查看服务日志
sudo journalctl -u raspberrycloud -n 50


# ============================================
# 常用管理命令
# ============================================

# 重启服务
sudo systemctl restart raspberrycloud

# 查看服务状态
sudo systemctl status raspberrycloud

# 查看实时日志
sudo journalctl -u raspberrycloud -f

# 查看错误日志
sudo tail -f /var/log/raspberrycloud/backend_error.log

