# æ¸…ç†æ—§éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•å®‰å…¨åœ°åˆ é™¤ `/opt/raspberrycloud` ç›®å½•ä¸­çš„æ—§é¡¹ç›®æ–‡ä»¶ã€‚

## âš ï¸ é‡è¦è­¦å‘Š

åˆ é™¤å‰è¯·ç¡®è®¤ï¼š
- âœ… å·²å¤‡ä»½é‡è¦æ•°æ®ï¼ˆé…ç½®æ–‡ä»¶ã€æ•°æ®åº“ã€ç”¨æˆ·æ–‡ä»¶ï¼‰
- âœ… ç¡®è®¤ä¸å†éœ€è¦æ—§çš„éƒ¨ç½²
- âœ… å·²è®°å½•é‡è¦çš„é…ç½®ä¿¡æ¯

## ğŸ”’ å®‰å…¨åˆ é™¤æ­¥éª¤

### æ­¥éª¤1ï¼šå¤‡ä»½é‡è¦æ•°æ®

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ~/raspberrycloud_backup_$(date +%Y%m%d)
cd ~/raspberrycloud_backup_$(date +%Y%m%d)

# å¤‡ä»½é…ç½®æ–‡ä»¶
sudo cp /opt/raspberrycloud/backend/.env ./.env.backup 2>/dev/null || echo "æœªæ‰¾åˆ°.envæ–‡ä»¶"

# å¤‡ä»½æ•°æ®åº“æ–‡ä»¶ï¼ˆSQLiteï¼‰
sudo cp /opt/raspberrycloud/backend/*.db ./database_backup.db 2>/dev/null || echo "æœªæ‰¾åˆ°æ•°æ®åº“æ–‡ä»¶"

# å¤‡ä»½æ•´ä¸ªé¡¹ç›®ï¼ˆå¯é€‰ï¼Œå¦‚æœç¡¬ç›˜ç©ºé—´è¶³å¤Ÿï¼‰
sudo cp -r /opt/raspberrycloud ./raspberrycloud_full_backup

echo "å¤‡ä»½å®Œæˆï¼Œä¿å­˜åœ¨: $(pwd)"
```

### æ­¥éª¤2ï¼šåœæ­¢ç›¸å…³æœåŠ¡

```bash
# åœæ­¢RaspberryCloudæœåŠ¡
sudo systemctl stop raspberrycloud

# ç¦ç”¨å¼€æœºè‡ªå¯
sudo systemctl disable raspberrycloud

# æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆåº”è¯¥æ˜¾ç¤ºinactiveï¼‰
sudo systemctl status raspberrycloud
```

### æ­¥éª¤3ï¼šåˆ é™¤systemdæœåŠ¡é…ç½®

```bash
# åˆ é™¤æœåŠ¡æ–‡ä»¶
sudo rm /etc/systemd/system/raspberrycloud.service

# é‡æ–°åŠ è½½systemd
sudo systemctl daemon-reload

# é‡ç½®å¤±è´¥çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
sudo systemctl reset-failed
```

### æ­¥éª¤4ï¼šåˆ é™¤ç”Ÿäº§æ–‡ä»¶å¤¹

```bash
# åˆ é™¤/opt/raspberrycloudç›®å½•
sudo rm -rf /opt/raspberrycloud

# ç¡®è®¤åˆ é™¤æˆåŠŸ
ls /opt/raspberrycloud 2>/dev/null && echo "fail" || echo "âœ… success"
```

### æ­¥éª¤5ï¼šåˆ é™¤å‰ç«¯æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ é™¤Webæ ¹ç›®å½•çš„å‰ç«¯æ–‡ä»¶
sudo rm -rf /var/www/raspberrycloud

# ç¡®è®¤åˆ é™¤
ls /var/www/raspberrycloud 2>/dev/null && echo "fail" || echo "âœ… success"
```

### æ­¥éª¤6ï¼šåˆ é™¤Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ é™¤Nginxé…ç½®è½¯é“¾æ¥
sudo rm /etc/nginx/sites-enabled/raspberrycloud

# åˆ é™¤é…ç½®æ–‡ä»¶
sudo rm /etc/nginx/sites-available/raspberrycloud

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl reload nginx
```

### æ­¥éª¤7ï¼šåˆ é™¤æ—¥å¿—æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

```bash
# åˆ é™¤æ—¥å¿—ç›®å½•
sudo rm -rf /var/log/raspberrycloud

# ç¡®è®¤åˆ é™¤
ls /var/log/raspberrycloud 2>/dev/null && echo "fail" || echo "success"
```

### æ­¥éª¤8ï¼šæ¸…ç†ç”¨æˆ·æ•°æ®ï¼ˆè°¨æ…ï¼ï¼‰

âš ï¸ **è­¦å‘Š**ï¼šè¿™ä¼šåˆ é™¤æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼

```bash
# ä»…åœ¨ç¡®å®šä¸éœ€è¦ç”¨æˆ·æ•°æ®æ—¶æ‰§è¡Œ
# sudo rm -rf /mnt/cloud_storage/users
# sudo rm -rf /mnt/cloud_storage/shares
# sudo rm -rf /mnt/cloud_storage/temp
```

## ğŸš€ ä¸€é”®æ¸…ç†è„šæœ¬ï¼ˆå®Œæ•´ç‰ˆï¼‰

åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–æ¸…ç†è„šæœ¬ï¼š

```bash
#!/bin/bash
#
# æ¸…ç†æ—§éƒ¨ç½²è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: sudo bash cleanup_old_deployment.sh
#

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}========================================${NC}"
echo -e "${YELLOW}æ¸…ç†æ—§çš„RaspberryCloudéƒ¨ç½²${NC}"
echo -e "${YELLOW}========================================${NC}"
echo ""

# æ£€æŸ¥rootæƒé™
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[é”™è¯¯]${NC} æ­¤è„šæœ¬éœ€è¦rootæƒé™"
    echo "è¯·ä½¿ç”¨: sudo bash cleanup_old_deployment.sh"
    exit 1
fi

# ç¡®è®¤æ“ä½œ
echo -e "${RED}âš ï¸  è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤ä»¥ä¸‹å†…å®¹ï¼š${NC}"
echo "  - /opt/raspberrycloud/"
echo "  - /var/www/raspberrycloud/"
echo "  - /etc/systemd/system/raspberrycloud.service"
echo "  - /etc/nginx/sites-*/raspberrycloud"
echo "  - /var/log/raspberrycloud/"
echo ""
read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ(è¾“å…¥ yes ç¡®è®¤): " -r
if [[ ! $REPLY == "yes" ]]; then
    echo "å·²å–æ¶ˆæ“ä½œ"
    exit 0
fi

# åˆ›å»ºå¤‡ä»½
BACKUP_DIR="$HOME/raspberrycloud_backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"
echo -e "${GREEN}[1/8]${NC} å¤‡ä»½é‡è¦æ•°æ®åˆ°: $BACKUP_DIR"

if [ -f "/opt/raspberrycloud/backend/.env" ]; then
    cp /opt/raspberrycloud/backend/.env "$BACKUP_DIR/.env.backup"
    echo "  âœ… å·²å¤‡ä»½.envé…ç½®æ–‡ä»¶"
fi

if [ -f "/opt/raspberrycloud/backend/raspberrycloud.db" ]; then
    cp /opt/raspberrycloud/backend/raspberrycloud.db "$BACKUP_DIR/database.db"
    echo "  âœ… å·²å¤‡ä»½æ•°æ®åº“æ–‡ä»¶"
fi

# åœæ­¢æœåŠ¡
echo -e "${GREEN}[2/8]${NC} åœæ­¢æœåŠ¡..."
systemctl stop raspberrycloud 2>/dev/null && echo "  âœ… æœåŠ¡å·²åœæ­¢" || echo "  âš ï¸  æœåŠ¡æœªè¿è¡Œ"
systemctl disable raspberrycloud 2>/dev/null && echo "  âœ… å·²ç¦ç”¨å¼€æœºè‡ªå¯" || echo "  âš ï¸  æœåŠ¡æœªå¯ç”¨"

# åˆ é™¤systemdé…ç½®
echo -e "${GREEN}[3/8]${NC} åˆ é™¤systemdé…ç½®..."
rm -f /etc/systemd/system/raspberrycloud.service && echo "  âœ… å·²åˆ é™¤æœåŠ¡æ–‡ä»¶" || echo "  âš ï¸  æœªæ‰¾åˆ°æœåŠ¡æ–‡ä»¶"
systemctl daemon-reload
systemctl reset-failed 2>/dev/null

# åˆ é™¤ç”Ÿäº§ç›®å½•
echo -e "${GREEN}[4/8]${NC} åˆ é™¤ç”Ÿäº§ç›®å½•..."
if [ -d "/opt/raspberrycloud" ]; then
    rm -rf /opt/raspberrycloud
    echo "  âœ… å·²åˆ é™¤ /opt/raspberrycloud"
else
    echo "  âš ï¸  ç›®å½•ä¸å­˜åœ¨"
fi

# åˆ é™¤å‰ç«¯æ–‡ä»¶
echo -e "${GREEN}[5/8]${NC} åˆ é™¤å‰ç«¯æ–‡ä»¶..."
if [ -d "/var/www/raspberrycloud" ]; then
    rm -rf /var/www/raspberrycloud
    echo "  âœ… å·²åˆ é™¤ /var/www/raspberrycloud"
else
    echo "  âš ï¸  ç›®å½•ä¸å­˜åœ¨"
fi

# åˆ é™¤Nginxé…ç½®
echo -e "${GREEN}[6/8]${NC} åˆ é™¤Nginxé…ç½®..."
rm -f /etc/nginx/sites-enabled/raspberrycloud && echo "  âœ… å·²åˆ é™¤è½¯é“¾æ¥" || echo "  âš ï¸  æœªæ‰¾åˆ°è½¯é“¾æ¥"
rm -f /etc/nginx/sites-available/raspberrycloud && echo "  âœ… å·²åˆ é™¤é…ç½®æ–‡ä»¶" || echo "  âš ï¸  æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶"
nginx -t && systemctl reload nginx && echo "  âœ… Nginxå·²é‡æ–°åŠ è½½"

# åˆ é™¤æ—¥å¿—
echo -e "${GREEN}[7/8]${NC} åˆ é™¤æ—¥å¿—æ–‡ä»¶..."
if [ -d "/var/log/raspberrycloud" ]; then
    rm -rf /var/log/raspberrycloud
    echo "  âœ… å·²åˆ é™¤æ—¥å¿—ç›®å½•"
else
    echo "  âš ï¸  æ—¥å¿—ç›®å½•ä¸å­˜åœ¨"
fi

# è¯¢é—®æ˜¯å¦åˆ é™¤ç”¨æˆ·æ•°æ®
echo -e "${GREEN}[8/8]${NC} ç”¨æˆ·æ•°æ®å¤„ç†..."
echo -e "${YELLOW}âš ï¸  æ˜¯å¦åˆ é™¤ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Ÿ${NC}"
echo "    ä½ç½®: /mnt/cloud_storage/users"
read -p "åˆ é™¤ç”¨æˆ·æ•°æ®ï¼Ÿ(è¾“å…¥ yes ç¡®è®¤): " -r
if [[ $REPLY == "yes" ]]; then
    rm -rf /mnt/cloud_storage/users
    rm -rf /mnt/cloud_storage/shares
    rm -rf /mnt/cloud_storage/temp
    echo "  âœ… å·²åˆ é™¤ç”¨æˆ·æ•°æ®"
else
    echo "  âš ï¸  ä¿ç•™ç”¨æˆ·æ•°æ®"
fi

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}æ¸…ç†å®Œæˆï¼${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${GREEN}å¤‡ä»½ä½ç½®:${NC} $BACKUP_DIR"
echo -e "${GREEN}å·²åˆ é™¤:${NC}"
echo "  âœ… /opt/raspberrycloud/"
echo "  âœ… /var/www/raspberrycloud/"
echo "  âœ… systemdæœåŠ¡é…ç½®"
echo "  âœ… Nginxé…ç½®"
echo "  âœ… æ—¥å¿—æ–‡ä»¶"
echo ""
echo -e "${YELLOW}æç¤º:${NC} å¦‚éœ€é‡æ–°éƒ¨ç½²ï¼Œè¯·è¿è¡Œ:"
echo "  cd ~/Desktop/Github/RaspiOwnCloud"
echo "  sudo bash scripts/initial_deploy.sh"
echo ""
```

å°†ä¸Šé¢çš„è„šæœ¬ä¿å­˜ä¸º `cleanup_old_deployment.sh`ï¼Œç„¶åè¿è¡Œï¼š

```bash
sudo bash cleanup_old_deployment.sh
```

## ğŸ“‹ å¿«é€Ÿåˆ é™¤ï¼ˆä»…åˆ é™¤ç›®å½•ï¼‰

å¦‚æœåªæƒ³å¿«é€Ÿåˆ é™¤ç›®å½•ï¼Œä¸éœ€è¦å¤‡ä»½ï¼š

```bash
# åœæ­¢æœåŠ¡
sudo systemctl stop raspberrycloud 2>/dev/null

# åˆ é™¤ç”Ÿäº§ç›®å½•
sudo rm -rf /opt/raspberrycloud

# ç¡®è®¤åˆ é™¤
ls /opt/raspberrycloud 2>/dev/null && echo "âŒ åˆ é™¤å¤±è´¥" || echo "âœ… åˆ é™¤æˆåŠŸ"
```

## ğŸ” éªŒè¯æ¸…ç†ç»“æœ

è¿è¡Œä»¥ä¸‹å‘½ä»¤ç¡®è®¤æ‰€æœ‰å†…å®¹éƒ½å·²åˆ é™¤ï¼š

```bash
# æ£€æŸ¥ç”Ÿäº§ç›®å½•
ls /opt/raspberrycloud 2>/dev/null && echo "âŒ ç›®å½•ä»å­˜åœ¨" || echo "âœ… ç›®å½•å·²åˆ é™¤"

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status raspberrycloud 2>/dev/null && echo "âŒ æœåŠ¡ä»å­˜åœ¨" || echo "âœ… æœåŠ¡å·²åˆ é™¤"

# æ£€æŸ¥å‰ç«¯ç›®å½•
ls /var/www/raspberrycloud 2>/dev/null && echo "âŒ å‰ç«¯ä»å­˜åœ¨" || echo "âœ… å‰ç«¯å·²åˆ é™¤"

# æ£€æŸ¥Nginxé…ç½®
ls /etc/nginx/sites-enabled/raspberrycloud 2>/dev/null && echo "âŒ Nginxé…ç½®ä»å­˜åœ¨" || echo "âœ… Nginxé…ç½®å·²åˆ é™¤"
```

## ğŸ”„ åˆ é™¤åé‡æ–°éƒ¨ç½²

æ¸…ç†å®Œæˆåï¼Œå¦‚éœ€é‡æ–°éƒ¨ç½²ï¼š

```bash
# 1. ç¡®ä¿æ›´æ–°æ–‡ä»¶å¤¹å­˜åœ¨
cd ~/Desktop/Github/RaspiOwnCloud

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. è¿è¡Œåˆå§‹éƒ¨ç½²
sudo bash scripts/initial_deploy.sh

# 4. æ¢å¤é…ç½®ï¼ˆå¦‚æœä¹‹å‰æœ‰å¤‡ä»½ï¼‰
sudo cp ~/raspberrycloud_backup_YYYYMMDD/.env.backup /opt/raspberrycloud/backend/.env
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q: åˆ é™¤æ—¶æç¤º"è®¾å¤‡æˆ–èµ„æºå¿™"ï¼Ÿ

```bash
# æŸ¥çœ‹å“ªäº›è¿›ç¨‹åœ¨ä½¿ç”¨è¯¥ç›®å½•
sudo lsof +D /opt/raspberrycloud

# å¼ºåˆ¶åœæ­¢ç›¸å…³è¿›ç¨‹
sudo systemctl stop raspberrycloud
sudo pkill -f raspberrycloud

# å†æ¬¡å°è¯•åˆ é™¤
sudo rm -rf /opt/raspberrycloud
```

### Q: åˆ é™¤åæƒ³æ¢å¤æ€ä¹ˆåŠï¼Ÿ

```bash
# ä»å¤‡ä»½æ¢å¤
sudo cp -r ~/raspberrycloud_backup_YYYYMMDD/raspberrycloud_full_backup /opt/raspberrycloud

# å¯åŠ¨æœåŠ¡
sudo systemctl start raspberrycloud
```

### Q: åªæƒ³é‡æ–°éƒ¨ç½²ä»£ç ï¼Œä¿ç•™é…ç½®ï¼Ÿ

```bash
# åªåˆ é™¤ä»£ç æ–‡ä»¶ï¼Œä¿ç•™.envå’Œæ•°æ®åº“
sudo rm -rf /opt/raspberrycloud/backend/*.py
sudo rm -rf /opt/raspberrycloud/backend/venv

# é‡æ–°éƒ¨ç½²
cd ~/Desktop/Github/RaspiOwnCloud
bash scripts/quick_update.sh
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŒæ–‡ä»¶å¤¹éƒ¨ç½²æ¶æ„è¯´æ˜](åŒæ–‡ä»¶å¤¹éƒ¨ç½²æ¶æ„è¯´æ˜.md)
- [ç³»ç»Ÿéƒ¨ç½²æ•™ç¨‹](02-ç³»ç»Ÿéƒ¨ç½²æ•™ç¨‹.md)
- [é—®é¢˜æ’æŸ¥æ‰‹å†Œ](05-é—®é¢˜æ’æŸ¥æ‰‹å†Œ.md)

